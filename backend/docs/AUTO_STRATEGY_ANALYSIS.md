# Auto Strategy 機能分析レポート：課題と改善計画

## 概要

現在のオートストラテジー機能（`auto_strategy` モジュール）のコードベース分析により特定された、**未解決の課題**と**今後の改善計画**をまとめたドキュメントです。
完了済みの項目については [AUTO_STRATEGY_COMPLETED.md](./AUTO_STRATEGY_COMPLETED.md) を参照してください。

## 3. 設定と拡張性の課題 (Scalability & Configuration)

### 3.2 TPSL（利確・損切）の柔軟性不足

**現状:**

- `TPSLGene` は戦略全体で共有される単一のオブジェクトです。
- ロング・ショートで個別の TPSL 設定を持つことや、市場状況（ボラティリティなど）に応じて TPSL ロジックを動的に切り替える構造になっていません。
- `TPSLService` の多くのロジックでフォールバック（固定％）が発生しやすい構造です。

### 3.3 エントリータイプの固定化とデータ粒度の課題 (Order Execution & Data Granularity)

**現状:**

- 戦略遺伝子 (`StrategyGene`) に注文タイプ（成行、指値、逆指値）を保持するフィールドが存在せず、バックテスト時も成行注文（Market Order）が固定的に使用されています。
- 一方で、現在のバックテスト環境は OHLCV データ（1 分足〜日足）のみを使用しており、ティックデータ（Tick Data）や板情報が存在しません。

**影響:**

- **戦略の多様性欠如**:「押し目買い（Limit）」や「ブレイクアウト（Stop）」といった手法を表現できません。
- **シミュレーション精度の限界**: 仮に指値・逆指値を導入しても、ティックデータがないため「バー内部での高値・安値の到達順序」が不明です。これにより、「ヒゲで約定して反発した」という **幻の利益（バックテスト詐欺）** や、利確・損切りの順序判定ミスが発生するリスクがあり、導入には慎重な検討（または下位足シミュレーション）が必要です。

## 4. データ分析・運用の課題

### 4.1 データベース分析の困難性 (Wait-for-Analysis Bottleneck)

**現状:**

- 戦略の構造データ（どの指標を使ったか、どのパラメータだったか）が `GeneratedStrategy` テーブルの `gene_data` カラム（JSON 型）にシリアライズされて格納されています。
- 「RSI を使用した戦略の平均勝率は？」といったメタ分析を行いたい場合、SQL レベルでの集計が困難で、アプリケーション側で全レコードをフェッチ・パースする必要があります。

**影響:**

- **科学的アプローチの阻害**: 数千、数万の仮想通貨戦略をバックテストした結果から「勝てるパターンの傾向」を導き出すためのデータマイニングが非常に非効率です。

## 5. 新たに発見された実装レベルの課題 (Additional Codebase Issues)

### 5.1 GAConfig のフィールド欠損 (Implicit Configuration)

**現状:**

- `GAConfig` クラス（`backend/app/services/auto_strategy/config/ga_runtime.py`）に `zero_trades_penalty` と `constraint_violation_penalty` フィールドが定義されていません。
- これらは `GASettings` や `GA_DEFAULT_CONFIG` には存在しますが、実行時に `IndividualEvaluator` が参照する `GAConfig` オブジェクトにはコピーされず、コード内で `getattr(config, "zero_trades_penalty", 0.1)` のように暗黙のデフォルト値が使用されています。

**影響:**

- **設定不整合**: ユーザーが設定ファイルや UI でペナルティ値を変更しても反映されません。常にデフォルト値（0.1 / 0.0）が使用され、意図した進化圧力がかからない可能性があります。

## 推奨される改善アクション（優先度順）

### Phase 2: 機能拡張 (High Impact)

1. **TPSL ロジックの多様化**: トレーリングストップや時間経過決済を遺伝子レベルで統合する。
2. **エントリータイプの多様化検討**: 下位足シミュレーションの導入や、バー確定後の擬似指値ロジックなど、データ精度を担保できる範囲での指値・逆指値導入を検討する。

### Phase 3: データ基盤と分析 (Data & Analysis)

1. **戦略メタデータの正規化**: 分析用に、主要な戦略特性（使用指標、タイムフレーム、リスク許容度など）を別のカラムまたはテーブルに抽出して保存する仕組みを検討する。
2. **リスク指標の高度化**: 非正規分布に対応したリスク指標（Sortino Ratio, Omega Ratio, VaR, CVaR）の導入。
3. **パラメータ整合性チェックの強化**: `IndicatorManifest` にパラメータ間の依存関係ルール（`fast < slow` など）を定義し、生成・変異時に強制する。

### Phase 4: コード品質と保守性 (Maintenance)

1. **GAConfig の修正**: 欠損しているペナルティ設定フィールドを追加し、設定の継承ロジックを修正する。
2. **パラメータ範囲の局所化**: 指標ごとに異なるパラメータ範囲を設定できる仕組み（`IndicatorManifest` の拡張など）を検討する。
