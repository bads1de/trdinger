# オートストラテジー ML機能 ワークフロー解説書

## 1. はじめに

このドキュメントは、オートストラテジーシステムに搭載されている機械学習（ML）機能のワークフローを解説するものです。MLがどのようにモデルを学習し、そのモデルを使って将来の値動きを予測しているのかを、技術的な詳細に馴染みのない方にも分かりやすく説明することを目的としています。

## 2. MLワークフローの全体像

本システムのML機能は、大きく分けて**「学習フェーズ」**と**「推論フェーズ」**の2つの段階で構成されています。

-   **学習フェーズ**: 過去の市場データから、値動きのパターンを学習し、予測モデルを構築します。これは、いわばAIに「教科書」を渡して勉強させる段階です。
-   **推論フェーズ**: 学習済みのモデルを使い、リアルタイムまたはバックテストの市場データに対して、将来の値動きを予測します。これは、勉強したAIが「模擬試験」や「本番の試験」に挑む段階に相当します。

---

## 3. フェーズ1: モデルの学習 (Training)

**目的**: 将来の値動き（上昇・下落・横ばい）を予測するための賢い「予測モデル」を作成すること。

このフェーズは、以下のステップで進行します。

### ステップ1: 学習の開始 (Trigger)

-   **方法**: ユーザーまたはシステムが、APIエンドポイント (`/api/ml/train`) に「学習を開始せよ」というリクエストを送信します。
-   **設定**: このとき、「どの通貨ペア（例: BTC/USDT）を」「どの時間軸（例: 1時間足）で」「どのくらいの期間（例: 2022年1月1日〜2023年12月31日）のデータで」学習させるかを指定します。

### ステップ2: データ収集 (Data Collection)

-   **処理**: システムは、指定された条件に基づいて、データベースから過去の市場データ（OHLCV、ファンディングレート、建玉情報など）を大量に収集します。

### ステップ3: 特徴量エンジニアリング (Feature Engineering)

-   **処理**: 生の市場データから、予測の手がかりとなる「特徴量」を計算します。これは、データをAIが理解しやすい形に加工する重要なプロセスです。
-   **特徴量の例**:
    -   **価格・出来高ベース**: 移動平均線、RSI、ボリンジャーバンドなどの基本的な指標。
    -   **市場構造ベース**: ファンディングレート（FR）と建玉（OI）の動向、およびそれらの価格との相関・逆相関。
    -   **ボラティリティベース**: 実現ボラティリティのスパイク、ATR（Average True Range）。
    -   **複合指標**: 市場の過熱度を示す指標（FRとOIの組み合わせ）など、複数の情報を統合した高度な特徴量。

### ステップ4: モデル学習 (Model Training)

-   **処理**: 高速かつ高精度な勾配ブースティングアルゴリズムである `LightGBM` を使い、ステップ3で作成した特徴量と、その後の実際の値動き（正解ラベル）の関係性を学習します。
-   **正解ラベル**: 将来の価格が、一定のしきい値（例: 2%）を超えて「上昇」したか、「下落」したか、その範囲内に収まる「レンジ」だったかの3択です。
-   **結果**: この学習を通じて、特定の「特徴量のパターン」が出現したときに、将来「上昇・下落・レンジ」のどれになりやすいかを判断できるモデルが完成します。

### ステップ5: モデルの保存 (Model Saving)

-   **処理**: 完成した学習済みモデルは、ファイルとしてシステム内に保存されます。これにより、いつでも推論フェーズで再利用できるようになります。

---
## 3.5. フェーズ1.5: モデルの自動再学習 (Auto Retraining)

**目的**: 市場の変化に対応し、予測モデルの鮮度と精度を常に高く維持すること。

一度学習したモデルも、時間の経過とともに市場の状況と合わなくなり、予測性能が劣化することがあります。それを防ぐため、本システムはモデルを自動的に再学習する仕組みを備えています。

### ステップ1: 再学習のトリガー (Trigger)

再学習は、以下のいずれかの条件を満たしたときに自動的に開始されます。

-   **定期的（スケジュール実行）**:
    -   **日次増分学習**: 毎日、前日の新しいデータのみを追加してモデルを更新します。
    -   **週次完全学習**: 毎週、過去の全データを使い、モデルをゼロから再構築します。
-   **性能劣化の検知**:
    -   **処理**: 定期的にモデルの予測精度を監視し、その精度が定められた閾値を下回った場合に再学習をトリガーします。
-   **データドリフトの検知**:
    -   **処理**: 新しい市場データの統計的性質（平均、分散など）が、学習時のデータから大きく乖離したことを検知した場合に再学習を促します。
-   **手動実行**:
    -   **処理**: 開発者や運用者が、必要に応じてAPI経由で任意のタイミングで再学習を開始することも可能です。

### ステップ2: 再学習の実行 (Execution)

-   **処理**: 上記のいずれかのトリガーが検知されると、**自動再学習スケジューラー**が作動します。スケジューラーは、新しい学習ジョブをキューに追加し、リソースが空き次第、**フェーズ1（モデルの学習）**で解説したプロセス（データ収集からモデル保存まで）を自動的に実行します。

この自動再学習サイクルにより、システムは常に最新の市場動向に適応した、精度の高い予測モデルを維持することができます。

## 4. フェーズ2: 予測指標の計算 (Inference)

**目的**: 学習済みモデルを使い、未知のデータに対して将来の値動き確率を予測し、それをストラテジーの判断材料として提供すること。

### ステップ1: モデルの読み込み (Model Loading)

-   **処理**: ストラテジーが実行される際、システムは保存されている最新の学習済みモデルを自動的に読み込みます。

### ステップ2: データ入力 (Data Input)

-   **処理**: バックテストやリアルタイム取引の過程で、新しいローソク足データが次々とシステムに入力されます。

### ステップ3: 特徴量エンジニアリング (Feature Engineering)

-   **処理**: 入力された新しいデータに対して、**学習時と全く同じ方法**で特徴量を計算します。これにより、モデルが学習したパターンと同じ土俵で比較できるようになります。

### ステップ4: 予測 (Prediction)

-   **処理**: 学習済みモデルは、計算された特徴量を分析し、次の期間の値動きが「上昇」「下落」「レンジ」になるそれぞれの**確率**を算出します。
-   **例**: 「上昇する確率: 65%, 下落する確率: 20%, レンジになる確率: 15%」といった結果が出力されます。

### ステップ5: 指標として出力 (Indicator Output)

-   **処理**: ステップ4で算出された確率は、以下の3つの新しいテクニカル指標としてストラテジーに提供されます。
    -   `ML_UP_PROB` (上昇確率)
    -   `ML_DOWN_PROB` (下落確率)
    -   `ML_RANGE_PROB` (レンジ確率)
-   **活用**: ストラテジーは、これらの確率指標を他の指標（例: RSIが70以上、など）と組み合わせることで、より精度の高い売買判断を行うことができます。さらに、このML指標は**遺伝的アルゴリズム（GA）による自動戦略生成**にも利用され、`ML_UP_PROB > 0.7` のような条件を取引ロジックの一部として動的に組み込み、最適な戦略を探索・進化させることが可能です。

---

## 5. 主要なコードコンポーネント

このワークフローは、主に以下のPythonファイルによって実現されています。

-   `backend/app/api/ml_training.py`
    -   役割: **手動での**学習プロセスの開始・停止・状態監視を行うAPIを提供します。
-   `backend/app/core/services/auto_retraining/auto_retraining_scheduler.py`
    -   役割: モデルの**自動再学習を管理するスケジューラー**。定期実行や性能劣化をトリガーに、学習プロセスを自動的に開始します。
-   `backend/app/core/services/auto_strategy/services/ml_indicator_service.py`
    -   役割: 学習と推論のプロセスを統括する司令塔。`FeatureEngineeringService`と`MLSignalGenerator`を連携させ、最終的なML指標を生成します。
-   `backend/app/core/services/feature_engineering/feature_engineering_service.py`
    -   役割: 市場データから**高度な特徴量（FR, OI, ボラティリティ等）**を計算する専門家。
-   `backend/app/core/services/ml/signal_generator.py`
    -   役割: **LightGBM**を用いたモデルの学習、予測、保存、読み込みといった実務を担当します。
-   `backend/app/core/services/auto_strategy/generators/random_gene_generator.py`
    -   役割: **遺伝的アルゴリズム（GA）**の一部として、ML指標を含む取引戦略（遺伝子）をランダムに生成します。
-   `frontend/app/api/ml/`
    -   役割: フロントエンドからバックエンドのML機能（学習の開始・停止・状態確認）を呼び出すための**プロキシAPI**を提供します。

## 6. まとめ

本システムのML機能は、過去のデータから値動きの法則性を自律的に学習し、その知識を使って未来を予測する強力なツールです。このワークフローを理解することで、ストラテジーがどのようにしてMLの予測を売買判断に組み込んでいるのか、その背景をより深く知ることができます。