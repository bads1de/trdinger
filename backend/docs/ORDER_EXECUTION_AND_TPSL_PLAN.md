# 注文約定と TPSL ロジック改善計画書

本ドキュメントでは、ティックデータが存在しない（1 分足 OHLCV のみ）環境下で、バックテストの信頼性を担保しつつ、柔軟な利益確定・損切り（TPSL）ロジックを実装するための設計方針を定義します。

## 1. 現状の課題

### 1.1 バックテストの信頼性 (Data Granularity Issue)

- **問題**: 1 分足内部の値動き（Intra-bar price movement）が不明なため、高値と安値のどちらに先に到達したか判定できない。
- **リスク**: 「実際には損切りされていたのに、バックテストでは利確されたことになる」という**幻の利益（Phantom Profit）**が発生する可能性がある。

### 1.2 TPSL 機能の硬直性

- **問題**: `backtesting.py` の標準機能に依存しているため、以下のような高度な機能が実装できない。
  - **トレーリングストップ**: 価格上昇に合わせて SL を引き上げる機能。
  - **時間経過決済**: 一定時間経過後にポジションを閉じる機能。
  - **動的変更**: ボラティリティの変化に応じて TP/SL 幅を調整する機能。

---

## 2. 解決策：悲観的約定モデル (Pessimistic Execution Model)

ティックデータがない場合でも、最悪のケース（安全側）を想定して判定を行うことで、バックテスト結果の信頼性を確保します。

### 2.1 基本原則

同一のローソク足内で「利確目標（TP）」と「損切りライン（SL）」の両方に価格が到達した場合、**無条件で「損切り」が先に発生した**とみなします。

### 2.2 判定ロジック詳細（ロングの場合）

`next()` メソッド（毎分の処理）の冒頭で以下の順序で判定を行います。

1. **損切り (SL) 判定 [最優先]**

   - `Low <= Stop Loss Price`
   - 直ちに決済（Exit）し、損失を確定させる。
   - **重要**: たとえ `High >= Take Profit Price` であっても無視する。

2. **利確 (TP) 判定 [次点]**

   - `High >= Take Profit Price`
   - 決済（Exit）し、利益を確定させる。

3. **ポジション継続**
   - 上記のいずれにも該当しない場合、ポジションを維持する。

### 2.3 実装方針

- `backtesting.py` の `self.buy(sl=..., tp=...)` 機能は**使用しない**（内部ブラックボックス挙動を避けるため）。
- 代わりに `UniversalStrategy` クラス内で `self.sl_price`, `self.tp_price` 変数を用いて自前で管理する。

---

## 3. 新機能：Bar-by-Bar トレーリングストップ

1 分ごとの足確定処理を利用して、擬似的なトレーリングストップを実装します。

### 3.1 動作ロジック

毎分の `next()` 処理において、ポジション維持が決定した後、以下のロジックで SL 価格を更新します。

1. **現在価格の参照**: 直前の足の `Close` または `High` を参照。
2. **新 SL の計算**: トレーリング設定（例: 現在価格 - 1%）に基づき計算。
3. **更新判定**:
   - ロングの場合: `新SL > 現在SL` ならば、`現在SL = 新SL` に更新。
   - **重要**: SL を有利な方向（利益確保方向）にのみ動かし、逆方向には絶対に動かさない。

### 3.2 メリット

- 計算コストが低く、GA（遺伝的アルゴリズム）の高速性を損なわない。
- 1 分足の終値ベースで判定するため、イントラバーのノイズによる「ダマシ」をある程度回避できる。

---

## 5. 実装可能な手法一覧 (Implementable Strategies)

悲観的約定モデルと Bar-by-Bar 更新を前提とすることで、以下の手法が実装可能になります。これらは今後の開発ロードマップに含まれます。

### 5.1 決済手法 (Exit Methods)

1. **トレーリングストップ (Trailing Stop)** ✅ IMPLEMENTED

   - **仕組み**: 価格が有利な方向に動いた場合、SL 価格を追従させて引き上げる。
   - **条件**: 足確定時に更新判定を行う。逆方向（不利な方向）への更新は行わない。
   - **判定**: `next()` 冒頭の悲観的 SL 判定で処理される。

2. **トレーリングテイクプロフィット (Trailing Take Profit)** ✅ IMPLEMENTED

   - **仕組み**: TP ラインに到達しても即時決済せず、「利益確保ライン」を設定して利益を伸ばす。価格が反転して確保ラインを割ったら決済。
   - **実装**:
     - `_tp_reached` フラグと `_trailing_tp_sl` 変数で内部ステート管理。
     - TP 到達後は、通常の TP 決済を無効化し、「終値からのドローダウン」による決済ロジックに切り替える。
   - **安全性**: 悲観的 SL 判定により、反転即決済のケースも安全に処理可能。

### 5.2 エントリー手法 (Entry Methods)

_※注意: エントリーに関しては、バックテスト詐欺を防ぐため、より厳格な制約（ペナルティ）を適用します。_

4. **指値エントリー (Limit Entry)**

   - **仕組み**: 「押し目買い」など、現在価格より有利な価格での約定を待つ。
   - **判定**: `Low <= Limit Price` (買いの場合)。
   - **安全策**: 「安値で約定した」判定が出ても、実際の約定価格は「指値価格」ではなく**「その足の終値 (Close)」** または **「指値価格 + スリッページ」** の悪い方を採用する。これにより「ヒゲの先端だけで拾えて爆益」という過剰適合を防ぐ。

5. **逆指値エントリー (Stop Entry / Breakout)**
   - **仕組み**: 「ブレイクアウト」など、特定の価格を超えたら飛び乗る。
   - **判定**: `High >= Stop Price` (買いの場合)。
   - **安全策**: 指値と同様、約定価格を**「その足の終値 (Close)」** または **「次の足の始値 (Open)」** とする。飛び乗り遅れ（Slippage）をシミュレーションに強制的に組み込む。

---

## 3.3 可視化とデバッグ (Visualization & Debugging)

- **課題**: `backtesting.py` 標準の `sl`/`tp` パラメータを使用しないため、デフォルトの HTML レポート上で TP/SL ライン（点線）が表示されなくなります。
- **対策**:
  - 開発・デバッグ段階では、計算した TP/SL 価格を `UniversalStrategy` 内で「インジケーター」として登録（`self.I`）し、チャート上に実線として描画させることで可視化します。
  - 本番運用時は非表示設定とし、パフォーマンスを優先します。

---

## 4. 実装計画

### Phase 1: `UniversalStrategy` の改修 ✅ COMPLETED

- [x] `__init__` で SL/TP 管理用のインスタンス変数を追加。
- [x] `next()` メソッドの冒頭に「悲観的決済ロジック」を追加。
- [x] 既存の `self.buy/sell` 呼び出しから `sl=`, `tp=` 引数を削除。
- [ ] **[追加]** SL/TP 価格をチャートにプロットするデバッグ用メソッドの実装。

### Phase 2: 遺伝子構造の拡張 (Gene Expansion)

- [x] **`TPSLGene` の更新**:
  - [x] `trailing_stop: bool` (トレーリング有効化) ✅
  - [x] `trailing_step_pct: float` (更新幅) ✅
  - [x] `trailing_take_profit: bool` (トレーリング TP 有効化) ✅
- [ ] **`StrategyGene` の更新** (指値・逆指値対応用):
  - [ ] `entry_type`: Enum (MARKET, LIMIT, STOP)
  - [ ] `entry_price_distance_pct`: float (指値などの距離)
- [ ] **スリッページ制御の実装**:
  - [ ] 悲観的決済時に、指定価格に対して一定のスリッページ（例: 0.1%）を強制的に負荷するロジックの追加。

### Phase 3: テストと検証 ✅ COMPLETED

- [x] 「利確と損切りが同時に発生する足」を含むテストデータを作成。 ✅
- [x] 悲観的ロジックにより「損切り」として処理されることをユニットテストで確認。 ✅
- [x] トレーリングストップが機能し、徐々に SL が切り上がる挙動を確認。 ✅
- [x] トレーリング TP 到達後、価格反転で利益確保ラインでの決済を確認。 ✅
