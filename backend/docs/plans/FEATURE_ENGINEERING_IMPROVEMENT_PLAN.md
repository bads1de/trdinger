# 特徴量エンジニアリング改善計画書 v2.0

## 1. 背景と目的

### 1.1. 現状の課題

- **モデル精度の低迷**: 現行モデルの精度は 0.46 であり、実用的な予測性能に達していない。
- **特徴量のノイズ化**: 生成された 122 個の特徴量のうち、約 64%（78 個）がノイズとして判定されており、モデルの過学習と汎化性能の低下を招いている。
- **特徴量の冗長性**: 多くの特徴量が互いに相関が高いか、モデルへの寄与がゼロまたは負であり、計算コストの増大とモデル解釈性の低下を招いている。
- **外部市場データの解像度不足**: 外部市場（S&P 500, NASDAQ 等）のデータが日足でのみ取得されており、より短期的な市場の相関を捉えるための特徴量生成が困難。

### 1.2. 目的

本計画の目的は、特徴量の「量」から「質」へと方針を転換し、以下の状態を達成することである。

- **高精度化**: 市場の本質的な動きを捉える特徴量セットを構築し、モデルの予測精度を **0.60 以上** に向上させる。
- **頑健性**: ノイズや冗長な情報を体系的に排除し、未知のデータや異なる市場レジームに対しても安定した性能を発揮する頑健なモデルを構築する。
- **解釈性**: 各特徴量の役割とモデルへの寄与度（SHAP 値など）を明確にし、モデルの判断根拠を論理的に説明可能にする。

## 2. 基本方針：特徴量の階層化と体系的検証

特徴量生成プロセスを以下の 3 つの階層に分け、各段階で厳格な検証を挟むことで、論理的かつ効果的な特徴量セットを構築する。

```mermaid
graph TD
    subgraph データソース
        DS1[OHLCV (BTC/USDT)]
        DS2[FR/OI]
        DS3[外部市場 (1H)]
        DS4[経済指標イベント]
    end

    subgraph L1_基本特徴量 [レイヤー1: 基本特徴量]
        L1_Price[価格変動 (Price_Change, TR, Volatility)]
        L1_FR[資金調達率 (FR_Change, FR_Volatility)]
        L1_OI[建玉 (OI_Change, OI_Flow)]
        L1_Time[時間的特徴 (Hour, Day, Weekday, Event_Flag)]
    end

    subgraph L2_複合特徴量 [レイヤー2: 複合・文脈特徴量]
        L2_Divergence[正規化ダイバージェンス (Price vs FR/OI)]
        L2_Interaction[市場間相関 (Rolling Correlation)]
        L2_Regime[動的市場レジーム (Volatility & Trend)]
        L2_Stress[Market Stress Index (動的重み付け)]
    end

    subgraph L3_解釈的特徴量 [レイヤー3: 解釈的・理論ベース特徴量]
        L3_Inefficiency[市場の非効率性 (Hurst Exponent)]
        L3_Flow[オーダーフロー不均衡 (CVD Proxy)]
        L3_Liquidity[流動性グラビティ (Liquidity Pool Gravity)]
    end

    subgraph 検証プロセス
        V1[Permutation Importance]
        V2[SHAP Analysis]
        V3[Ablation Study]
        V4[相関分析]
    end

    DS1 & DS2 & DS3 & DS4 --> L1_基本特徴量;
    L1_基本特徴量 -- 検証 --> L2_複合特徴量;
    L2_複合特徴量 -- 検証 --> L3_解釈的特徴量;
    L3_解釈的特徴量 -- 最終検証 --> MLモデル;
    L1_基本特徴量 --> V1 & V2 & V4;
    L2_複合特徴量 --> V1 & V2 & V4;
    L3_解釈的特徴量 --> V1 & V2 & V3 & V4;
```

- **レイヤー 1 (基本特徴量)**: 市場の一次情報をノイズ少なく抽出する。
- **レイヤー 2 (複合・文脈特徴量)**: 基本特徴量を組み合わせ、市場の文脈（レジーム、相関、乖離）を捉える。
- **レイヤー 3 (解釈的・理論ベース特徴量)**: 金融理論に基づき、より抽象的で強力な予測力を持つ特徴量を導入する。

## 3. 設計詳細

### 3.1. レイヤー 1: 基本特徴量の再構築

`permutation_importance` の結果を参考にしつつ、より本質的な情報を捉えるために特徴量を再定義・拡充する。

- **価格変動**: `Price_Change_1`, `TR` (True Range), `log_return`, `volatility_1h` (1 時間足の標準偏差)
- **資金調達率 (FR)**: `FR_Change`, `FR_Volatility` (FR の変化率のボラティリティ)
- **建玉 (OI)**: `OI_Change_Rate`, `OI_Flow_Proxy` (出来高で正規化した OI 変化)
- **時間**: `Hour_Sin`, `Day_Cos`, `Weekday_Sin/Cos`, `Is_FOMC_Week` (重要経済指標週フラグ)
- **外部市場**: `SP500_log_return_1h`, `NASDAQ_log_return_1h`

### 3.2. レイヤー 2: 既存特徴量の高度化と追加

- **ダイバージェンスの再定義**:
  - **手法**: 価格と他指標（FR, OI）の N 期間変化率を、それぞれの Z-score に変換してから差分を取る。これにより、異なるスケールの指標間での本質的な乖離を比較可能にする。
  - **式**: `Divergence_Price_OI = Z_Score(Price_Change_N) - Z_Score(OI_Change_N)`
- **市場レジームの高度化**:
  - **手法**: ATR を用いたボラティリティレジームに加え、ADX を用いたトレンドレジーム（トレンド相場 vs レンジ相場）を判定。これら 2 つのレジームを組み合わせ、4 つの市場状態（高ボラ・トレンド、高ボラ・レンジ、低ボラ・トレンド、低ボラ・レンジ）を定義する。
  - **応用**: `Market_Stress` の計算や、後段のモデルでカテゴリカル特徴量として利用する。
- **新規：市場間ローリング相関**:
  - **理論**: BTC 価格と外部市場（S&P500, VIX 指数等）との相関は時間と共に変化し、その変化自体がリスクオン/オフの指標となる。
  - **実装**: `rolling_correlation(BTC_return, SP500_return, window=24)` のように、24 時間窓などでの移動相関係数を計算する。

### 3.3. レイヤー 3: 新規特徴量（理論ベース）の設計と具体化

- **オーダーフローの偏り (Order Flow Imbalance - OFI)**:
  - **理論**: 市場の買い圧力と売り圧力の不均衡は、短期的な価格変動の主要因である。
  - **実装 (Proxy)**: 1 時間足データから、CVD (Cumulative Volume Delta) の代理変数を計算する。
    - `Price_Move = close - open`
    - `Volume_Direction = sign(Price_Move)`
    - `Delta = Volume_Direction * volume`
    - `CVD_Proxy = cumsum(Delta)`
    - 特徴量としては、`CVD_Proxy` の N 期間変化率 `CVD_Proxy_Change_N` を使用する。
- **市場の非効率性 (Market Inefficiency)**:
  - **理論**: Hurst 指数は、時系列がトレンド性 (H > 0.5)、平均回帰性 (H < 0.5)、ランダムウォーク (H ≈ 0.5) のいずれかを示す。
  - **実装**: `Hurst_Exponent` をローリング計算（例: 100 期間）し、市場が予測可能な状態（トレンド or 平均回帰）にあるかをモデルが学習できるようにする。`Hurst_Exponent - 0.5` を特徴量とし、0 からの乖離を捉える。
- **流動性の引力 (Liquidity Gravity)**:
  - **理論**: 価格は主要な流動性プール（直近の高値/安値、キリの良い価格帯）に引き寄せられる、あるいは反発する傾向がある。
  - **実装**:
    1. 直近 N 期間（例: 240 期間=10 日間）のスイングハイ/ローを特定する。
    2. 現在価格から最も近いスイングハイ/ローまでの距離（価格差の対数）を計算する: `Distance_to_Nearest_Liquidity`。
    3. そのレベルの強度を、過去に価格が反発した回数や、そのレベル付近での出来高集積を元にスコアリングする: `Liquidity_Level_Strength`。
    4. 最終的な特徴量 `Liquidity_Pool_Gravity = Liquidity_Level_Strength / Distance_to_Nearest_Liquidity` を設計する。

## 4. 実装計画

- **中心的な改修対象**: `backend/app/core/services/ml/feature_engineering/feature_engineering_service.py`
- **各特徴量クラスの改修**:
  - `price_features.py`: レイヤー 1 の再構築、CVD Proxy、流動性指標の追加。
  - `market_data_features.py`: レイヤー 1 の再構築、正規化ダイバージェンス、市場間ローリング相関の追加。
  - `technical_features.py`: レイヤー 1 の再構築、高度化された市場レジーム、Hurst 指数の追加。
- **既存特徴量の削除**: 上記で選択されなかった特徴量に関する計算ロジックは、コードから完全に削除し、技術的負債を残さない。

## 5. 検証・評価計画

特徴量の有効性を体系的に評価し、最終的な特徴量セットを決定する。

1.  **初期フィルタリング**:
    - **手法**: 相関行列、Variance Inflation Factor (VIF)。
    - **基準**: 相関係数が 0.9 以上のペアや、VIF が 10 を超える特徴量は、一方を削除または統合を検討する。
2.  **重要度評価**:
    - **手法**: `Permutation Importance`, `SHAP`。
    - **基準**: 重要度が低い、または負の影響を与える特徴量を削除候補とする。SHAP を用いて、特徴量がモデルの予測にどう貢献しているか（正負、非線形性）を可視化・分析する。
3.  **アブレーションスタディ (Ablation Study)**:
    - **手法**: ベースラインモデルから始め、L3, L2 の特徴量グループを一つずつ追加し、精度（Accuracy, F1-score）とシャープレシオの変化を測定する。
    - **目的**: どの特徴量グループがモデル性能向上に最も寄与するかを定量的に評価する。
4.  **最終選択**: 上記 1-3 の結果を総合的に判断し、最終的な特徴量セット（目標: 30〜50 個）を決定する。

## 6. データセットに関する変更

- **トレーニングデータ量**: モデルのトレーニングに使用する OHLCV データ量を **20,000 件** に増強する。これは、より長期のレジーム変化をモデルに学習させるためである。設定は `feature_noise_analysis_sqlite.py` や関連学習スクリプトで行う。
- **外部市場データの高解像度化**:
  - **目標**: 外部市場（S&P 500, NASDAQ, VIX 指数）のデータを、現在の日足から **1 時間足** に変更する。
  - **リスク**: 1 時間足データの取得 API が不安定、または有料である可能性。
  - **対策**:
    - **代替データソース**: 複数のデータプロバイダー（例: yfinance, Alpaca）を検討し、フォールバック機構を実装する。
    - **解像度の段階的利用**: 1 時間足が無理な場合、4 時間足データを代替として利用する。

## 7. 期待される効果

- **精度向上**: モデルの予測精度が **0.60 以上** に向上する。
- **汎化性能向上**: 特徴量数を 30〜50 個に厳選し、体系的な検証を行うことで過学習を抑制し、Walk-Forward Analysis での性能劣化を最小限に抑える。
- **モデルの解釈性向上**: SHAP サマリープロットや依存プロットを用いて、主要な特徴量が「なぜ」「どのように」予測に効いているのかを説明可能にする。
- **開発サイクルの高速化**: 特徴量生成パイプラインが構造化されることで、将来の新規特徴量の追加や実験が容易になる。
