# Trdinger ML Implementation Summary

このドキュメントは、Trdinger プロジェクトにおける機械学習パイプラインの実装状況、技術的決定、および成果を包括的にまとめたものです。他の LLM や開発者がプロジェクトの文脈を迅速に理解し、開発を継続するための資料として機能します。

## 1. プロジェクト概要

**Trdinger** は、ビットコイン無期限先物市場（BTC/USDT）を対象とした、高精度な定量的取引戦略を構築するための AI プラットフォームです。

- **目標**: レンジ相場での損失（往復ビンタ）を回避しつつ、トレンド発生時に高確度でエントリーするモデルの構築。
- **現状の到達点 (2025-11-24)**:
  - **Range 回避率**: **96.9%** (レンジ相場の誤検知をほぼ排除)
  - **Trend 確度**: **86.6%** (エントリー時の勝率)
  - **Trend 検出率**: **10.0%** (全トレンドのうち捕捉できる割合。改善傾向にあるが、さらなる向上が課題)

## 2. モデルアーキテクチャ (Stacking Ensemble)

多様性（Diversity）を確保するため、性質の異なる複数のモデルを組み合わせた **2 層スタッキング構成** を採用しています。

### Level-1: Base Models

以下の 5 つのモデルを並列に学習させます。

1. **LightGBM (GBDT)**: 高速かつ高精度。テーブルデータのパターン認識に優れる。
2. **XGBoost (GBDT)**: 安定性が高く、欠損値処理に優れる（`missing=np.inf` 設定済み）。
3. **CatBoost (GBDT)**: 時系列データやカテゴリカル変数に強く、過学習しにくい。今回の検証で最も高いパフォーマンスを示した。
4. **GRU (RNN)**: ゲート付き回帰型ユニット。時系列の短期〜中期の文脈（流れ）を学習する。
5. **LSTM (RNN)**: 長短期記憶ネットワーク。GRU より複雑な長期依存関係を捉える。

- **入力**:
  - GBDT 系: 生の特徴量（数値特徴量はクリッピング済み）。
  - DL 系 (GRU/LSTM): `StandardScaler` で正規化された特徴量。

### Level-2: Meta Learner

1. **Ridge Regression (NNLS)**:
   - 各 Level-1 モデルの **OOF (Out-Of-Fold)** 予測値を入力とする線形回帰モデル。
   - **Non-negative Least Squares (NNLS)** 制約 (`positive=True`) を適用し、負の重みを排除することで、モデルの解釈性と安定性を高めている。
   - これにより、各モデルの「信頼度」に基づいた最適な重み付けを自動学習する。

## 3. 特徴量エンジニアリング

ビットコイン市場特有の力学を捉えるため、独自の特徴量を多数実装しています（計 136 個）。

### 3.1 Funding Rate (FR) の高度化

生の FR データ（ratio）は数値が小さく 0 に張り付いているため、以下のように加工して学習効率を向上させました。

- **bps 変換**: 値を 10,000 倍し、ベーシスポイント単位に変換。
- **Deviation (乖離)**: ベースライン（0.01%）からの乖離量 (`fr_deviation_bps`) を計算。通常時は 0 になり、異常値を検出しやすい。
- **市場歪み指標**:
  - `fr_cumulative_deviation`: 乖離の累積エネルギー（マグマの蓄積）。
  - `fr_zscore`: 移動平均からの乖離（標準化）。
  - `OI_Weighted_FR`: 建玉残高（OI）で加重した FR。市場全体のコスト負担を表す。

### 3.2 RANGE 検出特化特徴量

レンジ相場を回避するために特化した特徴量群。

- `Price_Range_Normalized`: 価格レンジ幅を現在価格で正規化。
- `CHOP` (Choppiness Index): トレンドの不在を数値化。
- `BBW_Squeeze`: ボリンジャーバンドの収縮（スクイーズ）を検知。
- `Low_Volatility_Flag`: 過去のボラティリティ分布に基づく低ボラティリティ判定。

### 3.3 Multi-Timeframe (MTF)

- 1 時間足だけでなく、**4 時間足**、**24 時間足** にリサンプリングしたデータのテクニカル指標（RSI, ADX, BBW）を追加。
- 上位足のトレンド方向やボラティリティ環境を考慮可能にした。
- **実装上の注意**: 未来情報のリークを防ぐため、リサンプリング後に `reindex` と `ffill` を用いて慎重に結合している。

## 4. 検証手法: Purged K-Fold Cross Validation

金融時系列データにおける「情報のリーク」を防ぐため、厳密な交差検証手法を実装しました。

- **Purging (パージ)**: テスト期間と重複する、あるいは近接するトレーニングデータを削除する。
- **Embargo (エンバーゴ)**: テスト期間の直後のデータも、情報の遅延浸透を考慮してトレーニングから除外する（テスト期間の 1%）。
- **OOF 予測**: メタモデルの学習には、この Purged K-Fold を用いて生成された OOF 予測値のみを使用する。これにより、メタモデルの過学習を防ぎ、未知のデータに対する汎化性能を担保している。

## 5. 実装履歴と効果

| フェーズ    | 実装内容                       | 効果・結果                                                              |
| :---------- | :----------------------------- | :---------------------------------------------------------------------- |
| **Phase 1** | LightGBM/XGBoost 単体          | Range 回避率 79%。過学習の疑いあり。                                    |
| **Phase 2** | **CatBoost, GRU, LSTM 追加**   | モデル多様性が向上。DL モデルが一部の指標で GBDT を上回る。             |
| **Phase 3** | **FR 特徴量加工 & RANGE 指標** | Range 回避率が **100%** 近くまで向上。レンジ相場での損失リスクが激減。  |
| **Phase 4** | **Purged K-Fold CV 導入**      | 評価スコアが現実的な値に収束。Trend 検出率が 0.1% -> **10.0%** に改善。 |

## 6. 今後のロードマップ (Next Steps)

モデルの「守り（レンジ回避）」と「信頼性（検証）」は確立されました。次は「攻め（トレード機会の増加）」に焦点を当てます。

1. **Triple Barrier Method (TBM) の導入**:

   - 現在の単純な「n 期間後のリターン」によるラベル付けを廃止。
   - 「利確ライン」「損切りライン」「時間切れ」の 3 つのバリアを用いた動的なラベリングに変更する。
   - 期待効果: リスクリワード比の良いエントリーポイントを学習できるようになり、Trend 検出率がさらに向上する。

2. **メタラベリング (Meta-Labeling)**:

   - 1 次モデルが「エントリー」と判断したシグナルに対し、2 次モデルが「勝てる確率」を判定する構成にする。
   - 期待効果: サイズの大きなベットを行うべき局面の選定。

3. **特徴量の追加調査**:
   - On-chain データや Sentiment データの導入検討。

## 7. ファイル構造 (Key Files)

- `backend/scripts/ml_optimization/run_ml_pipeline.py`: パイプラインのエントリーポイント。Optuna 最適化、OOF 生成、スタッキング実行を統括。
- `backend/app/services/ml/feature_engineering/`: 特徴量計算ロジック。
  - `funding_rate_features.py`: FR 加工ロジック。
  - `advanced_features.py`: MTF, RANGE 指標など。
- `backend/app/services/ml/models/`: モデル定義。
  - `gru_model.py`, `lstm_model.py`: PyTorch 実装の DL モデル。
- `backend/app/services/ml/stacking_service.py`: Ridge Regression によるメタ学習器。
- `backend/app/utils/purged_cv.py`: Purged K-Fold の実装。
