# `backend/app/services` ディレクトリの多角的・包括的リファクタリング提案

このドキュメントは、`backend/app/services` ディレクトリ内の未リファクタリングのコンポーネントに関する今後の改善提案をまとめたものです。

---

## 共通のリファクタリング原則

コードベース全体の品質向上のため、以下の原則を適用します。

1.  **設定の外部化**: Pydanticモデルを使用し、設定をコードから分離します。
2.  **依存性注入 (DI)**: コンポーネント間の密結合を解消し、テスト容易性を向上させます。
3.  **単一責任の原則 (SRP)**: クラスとメソッドの責務を明確に分離します。
4.  **抽象化レイヤーの導入**: 外部ライブラリへの直接依存を避け、アダプターパターンなどを活用します。
5.  **堅牢なエラーハンドリング**: カスタム例外を定義し、エラー処理を統一します。
6.  **パフォーマンス最適化**: ベクトル化操作を活用し、メモリ管理を徹底します。
7.  **コード品質向上**: PEP 8に準拠し、命名規則やロギングを統一します。

---

### 1. `strategy_integration_service.py`

-   **課題**: データ構造の不整合、N+1問題、複雑な変換ロジック、マジックナンバー。
-   **提案**:
    -   データ生成元でデータ構造を正規化する。
    -   Eager Loadingを活用し、DBクエリを効率化する。
    -   変換ロジックを独立したヘルパークラスに分離する (SRP)。
    -   リスクレベルの閾値などを設定ファイルに外部化する。

### 2. `auto_strategy/` ディレクトリ

-   **課題**: DEAPライブラリへの強い結合、グローバル状態、マジックナンバー、動的な属性アクセス、SRP違反。
-   **提案**:
    -   GAフレームワークの抽象化レイヤーを導入する。
    -   DIを徹底し、グローバル状態を排除する。
    -   すべての設定値を外部ファイルで一元管理する。
    -   責務過多なクラス (`StrategyFactory`など) を分割する。
    -   動的な属性アクセス (`getattr`など) を減らし、型ヒントを強化する。

### 3. `data_collection/` ディレクトリ

-   **課題**: SRP違反、依存性管理の欠如、マジックナンバー、不均一なエラーハンドリング、APIレート制限管理の不備。
-   **提案**:
    -   責務に応じてクラスをレイヤー化する (`ExchangeClient`, `DataFetcher`, `DataConverter`, `Repository`など)。
    -   DIを徹底する。
    -   API関連の設定を外部ファイルで一元管理し、レートリミッターを導入する。
    -   カスタム例外を用いてエラーハンドリングを統一する。

### 4. `indicators/` ディレクトリ

-   **課題**: マジックナンバー、複雑なマッピングロジック、ボイラープレートコード、`TechnicalIndicatorService`の責務過多。
-   **提案**:
    -   指標定義（パラメータ、デフォルト値など）をすべて外部設定ファイルに移行する。
    -   共通処理（バリデーション、エラーハンドリング）をデコレータで適用する。
    -   責務に応じてクラスを分割する (`IndicatorAdapter`, `IndicatorParameterManager`など)。
    -   `talib`への直接依存をアダプターパターンで抽象化する。

### 5. `ml/` ディレクトリ

-   **課題**: PEP 8違反の設定命名、グローバル状態、AutoMLの複雑性とメモリ管理の問題、不完全なモデル管理。
-   **提案**:
    -   設定クラスの命名を`snake_case`に修正し、Pydanticで管理を徹底する。
    -   DIを徹底し、グローバル状態 (`training_status`など) を専用の管理クラスにカプセル化する。
    -   責務に応じてサービスを分割する (`MLTrainingService`, `MLPredictionService`, `MLModelManagementService`など)。
    -   AutoMLのメモリ管理を強化し、リソース解放を徹底する。
    -   モデルレジストリやバージョン管理機能を強化する。

