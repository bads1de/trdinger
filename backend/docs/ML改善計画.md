# Trdinger 向け機械学習改善計画

## 1. 現状の性能と課題

- ベストモデル: XGBoost（Optuna 10 トライアル）、macro F1 約 41.4%。
- クラス別挙動（DOWN / RANGE / UP の 3 クラス）:
  - DOWN: 正解率 約 22.6%（壊滅的）。
  - UP: 正解率 約 38.7%（不十分）。
  - RANGE: 正解率 約 65.7%（RANGE に強くバイアス）。
- 主な症状:
  - 約 16 時間の長い予測ホライズン + 約 0.2%の非常に小さい閾値により、ラベルがノイジーかつ分離困難。
  - 軽度なクラス不均衡と、方向性・モメンタム情報の不足により、DOWN/UP の識別性能が低い。

## 2. 研究に基づく根本原因分析

1. **予測ホライズンと閾値設定**

   - 先行研究では、BTC/暗号資産の方向予測において 1〜4 時間（最大でも 8 時間程度）の短期ホライズンが有利と報告されている。
   - 現状の 16 時間ホライズン + 0.2% 閾値は以下を招く:
     - クラス間の境界が曖昧になり、UP/DOWN と RANGE が大きく重なる。
     - 小幅変動が多く、ラベルの一貫性が崩れやすい。

2. **クラス不均衡と意思決定バイアス**

   - 極端な不均衡ではないが、RANGE が相対的に扱いやすく、決定木系モデルが RANGE 予測に寄りやすい。
   - DOWN/UP に対する損失重み付けや再サンプリングが弱く、誤分類コストが十分に反映されていない。

3. **特徴量セットとシグナル品質**

   - 研究事例では、MACD・各種 RSI・ボラティリティ・出来高・ファンディングレート構造などのトレンド/モメンタム系指標が高重要度であることが多い。
   - 低寄与特徴の削除によりクリーンにはなったが、短期モメンタムやボラティリティクラスタリングなど、方向性検出に有効な一部要素が弱くなっている可能性。

4. **ハイパーパラメータ探索不足**
   - Optuna 10 トライアルのみでは探索空間に対して明らかに不足しており、正則化・深さ・学習率などが最適化されていない可能性が高い。

## 3. 優先度付き改善戦略

### 戦略 1: ラベリング設計の見直し（最重要）

- **変更案**:
  - 予測ホライズン: 4 時間・8 時間のバリアントを試す。
  - 閾値: 絶対変化率 0.5% および 1.0% を候補とする。
- **狙い**:
  - ノイズとクラス重なりを削減し、方向性ラベルの一貫性を高める。
- **期待効果**:
  - 現状（約 41.4%）から macro F1 を +5〜10 ポイント程度改善しうる（特に DOWN/UP の安定化）。
- **実装メモ**:
  - `horizon_hours` と `threshold_pct` を設定から制御可能にする。
  - 学習・評価の両パイプラインで同一パラメータを参照してラベル生成。

### 戦略 2: クラス重み付けとコストセンシティブ学習

- **変更案**:
  - LightGBM/XGBoost に `class_weight="balanced"` またはカスタム重みを導入。
  - 重み自体も Optuna の探索対象とすることを検討。
- **狙い**:
  - DOWN/UP の誤分類コストを引き上げ、RANGE 偏重を抑制。
- **期待効果**:
  - DOWN/UP を中心に F1 が +3〜7 ポイント程度改善し、macro F1 のバランス向上。

### 戦略 3: SMOTE/ADASYN 等によるスマートなオーバーサンプリング（オフライン学習向け）

- **変更案**:
  - 学習データの fold 内でのみ、UP/DOWN が不足する場合に SMOTE/ADASYN を適用。
  - 検証/テストデータは元分布を維持し、リークを防止。
- **狙い**:
  - マイノリティパターンの多様性を補完し、決定境界を安定化。
- **期待効果**:
  - クラス重み付けと併用で macro F1 を +2〜5 ポイント押し上げる可能性（過学習には注意）。

### 戦略 4: ターゲットを絞った特徴量エンジニアリング強化

- **候補**:
  - 有効性が確認できる範囲で、方向性に効く指標を再導入/強調:
    - MACD / MACD シグナル、一部の実現ボラティリティ（例: realized_vol_20）、ファンディングレートの方向性特徴など。
  - 冗長性を抑えたモメンタム・レジーム特徴の追加:
    - 1h/2h/4h リターン、価格のロールング回帰傾き、ボラティリティレジーム分類など。
- **狙い**:
  - 方向性シグナルを強化しつつ、特徴量数を過度に増やさない。
- **期待効果**:
  - 適切に選別すれば macro F1 を +2〜6 ポイント改善しうる。

### 戦略 5: ハイパーパラメータ探索の拡張

- **変更案**:
  - LightGBM/XGBoost で Optuna トライアル数を 50〜100 に拡大。
  - 探索対象: 木の深さ、学習率、n_estimators、subsample、正則化、クラス重み等。
- **狙い**:
  - 過学習/過小学習のバランスを最適化し、安定した決定境界を構築。
- **期待効果**:
  - macro F1 を +2〜4 ポイント程度押し上げ、シード依存性も低減。

## 4. 実装ロードマップ

1. **フェーズ 1: ラベル・学習パイプラインの刷新**

   - 4h/8h ホライズンと 0.5〜1.0% 閾値を設定化し、データセットおよびモデルを再作成。
   - 学習コードに `class_weight` オプションを追加。

2. **フェーズ 2: 不均衡対策と特徴量見直し**

   - class_weight の有無、class_weight+SMOTE/ADASYN の組み合わせを比較評価。
   - 特徴量重要度を再計算し、有効なトレンド/モメンタム指標のみ選択的に復帰。

3. **フェーズ 3: 拡張ハイパーパラメータ探索**

   - 改善後のラベル・特徴量で 50〜100 トライアルの Optuna 最適化を実行。
   - クラス別 Precision/Recall（特に DOWN）をモニタし、閾値・重みを調整。

4. **フェーズ 4: 検証とデプロイ基準の定義**
   - 以下を満たすことを本番適用条件とする:
     - ホールドアウトデータで macro F1 ≥ 52〜58%。
     - DOWN/UP の Recall がベースラインより明確に改善。
   - 条件達成時に最適モデルと設定を固定し、運用フローに反映。

## 5. 現実的な性能上限の想定

- 暗号資産市場の高いランダム性を踏まえると、現実的な macro F1 の上限は 60〜65% 程度と見込まれる。
- 本計画は、現状の約 41% から 52〜58% 帯への到達を現実的な目標として、段階的かつ再現性のある改善を目指す。

## 6. 発展的戦略（本プロジェクト向けの位置づけ）

1. **トリプルバリアメソッドとメタラベリング**

   - 現段階では「固定ホライズン＋閾値ラベル（4〜8h, 0.5〜1.0%）」を採用し、実装と計算コストのシンプルさを優先する。
   - 中長期的な発展案として、ボラティリティ連動の TP/SL ＋時間制限を用いるトリプルバリア法と、シグナル真偽判定用のメタラベリングを導入候補として明記しておく。

2. **高価値特徴量候補**

   - 追加検討すべき特徴量を、次の「発展的オプション」として整理する:
     - HMM 等による市場レジーム特徴（高/低ボラ、トレンド/レンジ）。
     - 分数階差分を用いた価格・出来高系列（定常性を確保しつつ長期記憶を保持）。
     - 外部センチメント指標（例: Fear & Greed Index）とのマージ。
   - これらは即時導入ではなく、現行パイプラインでの改善効果を確認した後、段階的に A/B 評価する。

3. **検証・HPO における必須ルール**
   - 時系列 CV では TimeSeriesSplit（もしくは同等のウォークフォワード）を使用し、将来情報リーケージを防ぐ。
   - Optuna は Pruning を活用し、「限られた計算資源を有望な試行に集中させる」ことを標準プロセスとする。
