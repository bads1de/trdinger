# ML Codebase Review Report

## æ¦‚è¦

`backend/app/services/ml` ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¾ã—ãŸã€‚
è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆService å±¤ã€Trainerã€Strategy ãªã©ï¼‰ã«å¾“ã£ã¦æ§‹é€ åŒ–ã•ã‚Œã¦ã„ã¾ã™ãŒã€ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®æ‹¡å¤§ã«ä¼´ã„ã€ã„ãã¤ã‹ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä¸Šã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã€éåŠ¹ç‡ãªå®Ÿè£…ã€ãŠã‚ˆã³æ½œåœ¨çš„ãªãƒã‚°ãŒç¢ºèªã•ã‚Œã¾ã—ãŸã€‚

## ğŸš¨ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªå•é¡Œ (Critical Issues)

### 1. ãƒ©ãƒ™ãƒ«ã®å‹ä¸æ•´åˆãƒªã‚¹ã‚¯ (`presets.py` vs `MetaLabeling`)

**å•é¡Œ**:
`presets.py` ã§å®šç¾©ã•ã‚ŒãŸãƒ©ãƒ™ãƒ«ç”Ÿæˆé–¢æ•°ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ–‡å­—åˆ—ãƒ©ãƒ™ãƒ« (`"UP"`, `"DOWN"`, `"RANGE"`) ã‚’è¿”ã—ã¾ã™ã€‚ä¸€æ–¹ã€`MetaLabelingService` ã‚„ `StackingEnsemble` ã¯æ•°å€¤ï¼ˆãƒã‚¤ãƒŠãƒªï¼‰ãƒ©ãƒ™ãƒ« (`0`, `1`) ã‚’æœŸå¾…ã—ã¦ã„ã¾ã™ã€‚
ç¾åœ¨ã¯ `LabelCache` å†…ã§å¤‰æ›å‡¦ç†ãŒå…¥ã£ã¦ã„ã¾ã™ãŒã€å°†æ¥çš„ã« `presets` ã‚’ç›´æ¥åˆ©ç”¨ã—ã¦ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹éš›ã€å‹ã‚¨ãƒ©ãƒ¼ã‚„äºˆæœŸã›ã¬æŒ™å‹•ï¼ˆæ–‡å­—åˆ—ãŒæ•°å€¤ã¨ã—ã¦è§£é‡ˆã•ã‚Œãšã‚¨ãƒ©ãƒ¼ã€ã‚ã‚‹ã„ã¯ SILENT FAILUREï¼‰ãŒç™ºç”Ÿã™ã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:
`presets.py` ã®å„é–¢æ•°ã®æˆ»ã‚Šå€¤ã‚’çµ±ä¸€ã™ã‚‹ã‹ã€æ˜ç¢ºãªå‹å®šç¾©ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

## âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ (Performance Improvements)

### 1. DataFrame çµåˆã®éåŠ¹ç‡æ€§ (`FeatureEngineeringService.py`)

**å•é¡Œ**:
`calculate_advanced_features` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ã€`pd.concat` ãŒè¤‡æ•°å›ï¼ˆ5 å›ä»¥ä¸Šï¼‰é€£ç¶šã—ã¦å‘¼ã³å‡ºã•ã‚Œã¦ã„ã¾ã™ã€‚Pandas ã® `concat` ã¯éƒ½åº¦ãƒ¡ãƒ¢ãƒªã‚³ãƒ”ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ãŸã‚ã€å¤§ããªãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§ã¯ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å¤§ããªãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã¨ãªã‚Šã¾ã™ã€‚

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:
å„è¨ˆç®—æ©Ÿã‚¯ãƒ©ã‚¹ã‹ã‚‰è¿”ã•ã‚Œã‚‹ DataFrame ã‚’ãƒªã‚¹ãƒˆã«æ ¼ç´ã—ã€æœ€å¾Œã«ä¸€åº¦ã ã‘ `pd.concat` ã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚

### 2. Trend Scanning ã®ä½é€Ÿãªãƒ«ãƒ¼ãƒ—å‡¦ç† (`trend_scanning.py`)

**å•é¡Œ**:
`TrendScanning.get_labels` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ã€Python ã®ãƒã‚¤ãƒ†ã‚£ãƒ– `for` ãƒ«ãƒ¼ãƒ—ã‚’ä½¿ç”¨ã—ã¦å›å¸°åˆ†æã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚O(N^2) ã®è¨ˆç®—é‡ã¨ãªã‚Šã€é•·æœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ã‚„å¤šæ•°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¢ç´¢ã‚’è¡Œã†éš›ã«æ¥µã‚ã¦ä½é€Ÿã«ãªã‚Šã¾ã™ã€‚

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:
`numba` ã‚’ä½¿ç”¨ã—ã¦è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ JIT ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã‹ã€`numpy` ã®ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ãƒˆãƒªãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ•°åå€ã€œæ•°ç™¾å€ã®é«˜é€ŸåŒ–ãŒè¦‹è¾¼ã‚ã¾ã™ã€‚

## ğŸ› ï¸ ãã®ä»–ã®æ”¹å–„ææ¡ˆ (Other Suggestions)

### 1. æ¬ æå€¤å‡¦ç†ã®æ´—ç·´ (`FeatureEngineeringService.py`)

**å•é¡Œ**:
ç¾åœ¨ã€å…¨ã¦ã®ç‰¹å¾´é‡ã«å¯¾ã—ã¦ä¸€å¾‹ã§ `fillna(0.0)` ãŒé©ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã‚„ç‰¹å®šã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ï¼ˆä¾‹: RSI ã® 50ï¼‰ã«ãŠã„ã¦ã€`0` ã¯æ¥µç«¯ãªå€¤ã‚„ç•°å¸¸å€¤ã‚’æ„å‘³ã™ã‚‹å ´åˆãŒã‚ã‚Šã€ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ã‚’é˜»å®³ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:
ç‰¹å¾´é‡ã®æ€§è³ªã«å¿œã˜ã¦ã€ä»¥ä¸‹ã®æ¬ æå€¤å‡¦ç†ã‚’ä½¿ã„åˆ†ã‘ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

- **å‰æ–¹è£œå®Œ (`ffill`)**: ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ãªã©
- **ä¸­å¤®å€¤/å¹³å‡å€¤åŸ‹ã‚**: ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ç³»
- **å®šæ•°åŸ‹ã‚ (-1, -999)**: Tree ç³»ãƒ¢ãƒ‡ãƒ«ãŒæ¬ æã¨ã—ã¦æ‰±ã„ã‚„ã™ã„å€¤

## ğŸ”„ Round 2 Review: è¿½åŠ ã®ç™ºè¦‹äº‹é … (2025/12/07)

`backend/app/services/ml/feature_selection`, `orchestration`, `model_manager` ãªã©ã‚’ä¸­å¿ƒã«è¿½åŠ ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡Œã„ã¾ã—ãŸã€‚

## âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ (Performance Improvements - Round 2)

### 1. `MetricsCalculator` ã®è¨ˆç®—ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰

**å•é¡Œ**:
`MetricsCalculator.calculate_comprehensive_metrics` ã¯ã€å‘¼ã³å‡ºã•ã‚Œã‚‹ãŸã³ã« ROC-AUC, PR-AUC, æ··åŒè¡Œåˆ—, åˆ†é¡ãƒ¬ãƒãƒ¼ãƒˆãªã©ã€é‡ã„è¨ˆç®—ã‚’å…¨ã¦å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚å­¦ç¿’ä¸­ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒƒãƒ—ãªã©ã§é »ç¹ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã¨ã€å…¨ä½“ã®å‡¦ç†é€Ÿåº¦ã‚’ä½ä¸‹ã•ã›ã‚‹è¦å› ã«ãªã‚Šã¾ã™ã€‚

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:

- è¨ˆç®—ã™ã‚‹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ãƒ¬ãƒ™ãƒ«ã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼ˆä¾‹: `level="basic"` ã§ Accuracy/F1 ã®ã¿ã€`level="full"` ã§å…¨æŒ‡æ¨™ï¼‰ã€‚
- ã¾ãŸã¯ã€ROC-AUC ã‚„ PR-AUC ãªã©ã®é‡ã„è¨ˆç®—ã‚’å¿…è¦ãªå ´åˆã®ã¿å®Ÿè¡Œã™ã‚‹ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ ã™ã‚‹ã€‚

### 2. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç‰¹å¾´é‡é¸æŠæ‰‹æ³•ã®è¨ˆç®—ã‚³ã‚¹ãƒˆ (`MUTUAL_INFO`)

**å•é¡Œ**:
`FeatureSelector` ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§ `SelectionMethod.MUTUAL_INFO` ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ç›¸äº’æƒ…å ±é‡ã®è¨ˆç®—ï¼ˆk-è¿‘å‚æ³•ã«åŸºã¥ãï¼‰ã¯ã€ã‚µãƒ³ãƒ—ãƒ«æ•°ãŒå¤šã„æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦éå¸¸ã«è¨ˆç®—ã‚³ã‚¹ãƒˆãŒé«˜ã„ã§ã™ã€‚

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:

- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® `ensemble_methods` ã‹ã‚‰ `MUTUAL_INFO` ã‚’å¤–ã™ã‹ã€ã‚µãƒ³ãƒ—ãƒ«ãƒªãƒ³ã‚°ã‚’è¡Œã£ã¦ã‹ã‚‰è¨ˆç®—ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹ã€‚
- ã‚ˆã‚Šé«˜é€Ÿãª `f_classif` (ANOVA) ãªã©ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨ã™ã‚‹è¨­å®šã«ã™ã‚‹ã€‚

## ğŸ” Round 3 Review: Deep Dive (2025/12/06)

ã•ã‚‰ã«è©³ç´°ãªã‚³ãƒ¼ãƒ‰èª¿æŸ»ã‚’è¡Œã£ãŸçµæœã€ä»¥ä¸‹ã®æ”¹å–„ç‚¹ãŒç‰¹å®šã•ã‚Œã¾ã—ãŸã€‚ç‰¹ã« `VolumeProfile` ã®è¨ˆç®—å‡¦ç†ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å …ç‰¢æ€§ã«é–¢ã‚ã‚‹å•é¡Œã§ã™ã€‚

### ğŸš¨ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªå•é¡Œ (Critical Issues - Round 3)

### 1. `VolumeProfileFeatureCalculator` ã®æ¥µã‚ã¦ä½é€Ÿãªãƒ«ãƒ¼ãƒ—å‡¦ç†

**å•é¡Œ**:
`backend/app/services/ml/feature_engineering/volume_profile_features.py` ã® `_calculate_volume_profile_rolling` ãƒ¡ã‚½ãƒƒãƒ‰ã«ãŠã„ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãª Python ãƒã‚¤ãƒ†ã‚£ãƒ–ã®äºŒé‡ãƒ«ãƒ¼ãƒ—ãŒå­˜åœ¨ã—ã¾ã™ã€‚

```python
for i in range(window, len(df)):  # 20ä¸‡è¡Œã®ãƒ«ãƒ¼ãƒ—
    # ...
    # ã•ã‚‰ã«å†…éƒ¨ã§ for j in range(len(high_arr)): ã®ãƒ«ãƒ¼ãƒ—
```

ã“ã®å‡¦ç†ã¯ $O(N \cdot W)$ ï¼ˆ$N$=è¡Œæ•°, $W$=ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºï¼‰ã®è¨ˆç®—é‡ã‚’æŒã¡ã€20 ä¸‡è¡Œã®ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦å®Ÿè¡Œã™ã‚‹ã¨æ•°åˆ†ã€œæ•°ååˆ†ä»¥ä¸Šã‹ã‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚„å­¦ç¿’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å…¨ä½“ã®æ·±åˆ»ãªãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã§ã™ã€‚

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:

- **Numba ã®å°å…¥**: è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ `numba.jit` ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã€C è¨€èªä¸¦ã¿ã®é€Ÿåº¦ã«ã™ã‚‹ã€‚
- ã¾ãŸã¯ã€æ—¢å­˜ã®è¨ˆç®—ã‚’å¯èƒ½ãªé™ã‚Š Numpy ã®ãƒ™ã‚¯ãƒˆãƒ«æ¼”ç®—ï¼ˆ`histogram` ãªã©ï¼‰ã«ç½®ãæ›ãˆã‚‹ã€‚ã—ã‹ã—ã€Rolling Window ã§ã®ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ è¨ˆç®—ã¯ Numba ãŒæœ€é©è§£ã§ã™ã€‚

### 2. `EnsembleTrainer` ã®ã‚µã‚¤ãƒ¬ãƒ³ãƒˆå¤±æ•—ã¨ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒªã‚¹ã‚¯

**å•é¡Œ**:
`EnsembleTrainer.predict` ã‚„ `predict_proba` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒã€å®‰å…¨å´ã«å€’ã—ã™ãã¦ã„ã¾ã™ã€‚

```python
except Exception as e:
    logger.warning(f"ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«äºˆæ¸¬ç¢ºç‡ã®å–å¾—ã«å¤±æ•—ã—ãŸãŸã‚ã€ç©ºã®DataFrameã‚’ä½¿ç”¨ã—ã¾ã™: {e}")
    base_model_probs_df = pd.DataFrame(index=features_scaled.index)
```

ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«ã®äºˆæ¸¬ã«å¤±æ•—ã—ãŸå ´åˆã«ã€Œç©ºã® DataFrameã€ã§ç¶šè¡Œã—ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã‚’å—ã‘å–ã‚‹ãƒ¡ã‚¿ãƒ¢ãƒ‡ãƒ«ï¼ˆ`MetaLabelingService`ï¼‰ãŒç©ºã®å…¥åŠ›ã‚’æƒ³å®šã—ã¦ã„ãªã„å ´åˆã€èª¤ã£ãŸäºˆæ¸¬ã‚’å‡ºåŠ›ã™ã‚‹ã‹ã€ä¸‹æµã§ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚äºˆæ¸¬ã‚µãƒ¼ãƒ“ã‚¹ã®ä¿¡é ¼æ€§ï¼ˆReliabilityï¼‰ã«é–¢ã‚ã‚Šã¾ã™ã€‚

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:

- äºˆæ¸¬ã«å¤±æ•—ã—ãŸå ´åˆã¯ã€ä¸å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ã§æ¨è«–ã‚’ç¶šè¡Œã›ãšã€æ˜ç¤ºçš„ã«ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã‚‹ã‹ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆ"Range" ã‚„ No Tradeï¼‰ã‚’è¿”ã™ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹ã€‚
- å°‘ãªãã¨ã‚‚ã€é‡è¦ãªå…¥åŠ›ãŒæ¬ è½ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ãƒ¡ã‚¿ãƒ¢ãƒ‡ãƒ«ã‚’æ¨è«–ã•ã›ã‚‹ã“ã¨ã¯é¿ã‘ã‚‹ã¹ãã§ã™ã€‚

## âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ (Performance Improvements - Round 3)

### 1. `FeatureEngineeringService` ã®ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°éåŠ¹ç‡æ€§

**å•é¡Œ**:
`calculate_advanced_features` ãƒ¡ã‚½ãƒƒãƒ‰ã®æœ€å¾Œã«ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å‡¦ç†ãŒã€åˆ—ã”ã¨ã®ãƒ«ãƒ¼ãƒ—ã§å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚

```python
for col in numeric_columns:
    result_df[col] = result_df[col].replace([np.inf, -np.inf], np.nan)
    result_df[col] = result_df[col].ffill()
    result_df[col] = result_df[col].fillna(0.0)
```

åˆ—æ•°ãŒ 150 ä»¥ä¸Šã‚ã‚‹å ´åˆã€Pandas ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒç©ã¿é‡ãªã‚Šã¾ã™ã€‚

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:
DataFrame å…¨ä½“ã«å¯¾ã™ã‚‹ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã•ã‚ŒãŸæ“ä½œã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

```python
# ä¸€æ‹¬å‡¦ç†ã®ä¾‹
result_df[numeric_columns] = result_df[numeric_columns].replace([np.inf, -np.inf], np.nan)
result_df[numeric_columns] = result_df[numeric_columns].ffill().fillna(0.0)
```

## ğŸ” Round 4 Review: Additional Modules (2025/12/06)

`cross_validation`, `preprocessing`, `adaptive_learning`, `base_ml_trainer` ãªã©ã®è¿½åŠ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¾ã—ãŸã€‚

### ğŸš¨ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªå•é¡Œ (Critical Issues - Round 4)

### 1. `BaseMLTrainer` ã®ãƒ‡ãƒƒãƒ‰ã‚³ãƒ¼ãƒ‰ï¼ˆæœªåˆ°é”ã‚³ãƒ¼ãƒ‰ï¼‰

**å•é¡Œ**:
`base_ml_trainer.py` ã® `get_feature_importance` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã«ã€`return` æ–‡ã®å¾Œã«ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ã¾ã™ï¼ˆ656 è¡Œç›®ä»˜è¿‘ï¼‰ã€‚

```python
def get_feature_importance(self, top_n: int = 10) -> Dict[str, float]:
    # ...
    return get_feature_importance_unified(
        self._model, self.feature_columns, top_n=top_n
    )

    self.is_trained = False  # â† åˆ°é”ä¸èƒ½ï¼
    self.current_model_path = None
    self.current_model_metadata = None
    return True
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯æ±ºã—ã¦å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚æ„å›³ã—ãªã„ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã®çµæœã¨æ€ã‚ã‚Œã¾ã™ã€‚

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:
åˆ°é”ä¸èƒ½ãªã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚

### 2. `MarketRegimeDetector._calculate_features` ã®ãƒ«ãƒ¼ãƒ—åŠ¹ç‡æ€§

**å•é¡Œ**:
`market_regime_detector.py` ã® `_calculate_features` ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€Python ãƒã‚¤ãƒ†ã‚£ãƒ–ã® `for` ãƒ«ãƒ¼ãƒ—ã‚’ä½¿ç”¨ã—ã¦ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã”ã¨ã«çµ±è¨ˆé‡ã‚’è¨ˆç®—ã—ã¦ã„ã¾ã™ï¼ˆ402-450 è¡Œï¼‰ã€‚`lookback_period` ãŒå¤§ãã„å ´åˆã€è¨ˆç®—ã‚³ã‚¹ãƒˆãŒå¢—å¤§ã—ã¾ã™ã€‚

```python
for i in range(window, len(close)):
    window_returns = returns.iloc[i - window : i]
    # ... å„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ skew(), kurtosis(), std() ãªã©ã‚’è¨ˆç®—
```

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:
`pandas.rolling` ã‚’ä½¿ç”¨ã—ã¦çµ±è¨ˆé‡ã‚’è¨ˆç®—ã™ã‚‹ã“ã¨ã§ã€å¤§å¹…ãªé«˜é€ŸåŒ–ãŒè¦‹è¾¼ã‚ã¾ã™ã€‚

```python
rolling_returns = returns.rolling(window)
volatility = rolling_returns.std()
mean_return = rolling_returns.mean()
skewness = rolling_returns.skew()
kurtosis = rolling_returns.kurtosis()
```

## âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ (Performance Improvements - Round 4)

### 1. `preprocessing/pipeline.py` ã®é‡è¤‡é–¢æ•°å®šç¾©

**å•é¡Œ**:
`create_ml_pipeline` ã¨ `create_classification_pipeline` ã®ä¸¡æ–¹ã§ã€ã»ã¼åŒä¸€ã® `dataframe_to_array` ãƒ­ãƒ¼ã‚«ãƒ«é–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ï¼ˆ60-74 è¡Œã€152-166 è¡Œï¼‰ã€‚ã“ã‚Œã¯ã‚³ãƒ¼ãƒ‰ã®é‡è¤‡ã§ã‚ã‚Šã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚³ã‚¹ãƒˆã‚’å¢—åŠ ã•ã›ã¾ã™ã€‚

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:
`dataframe_to_array` ã‚’ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã¨ã—ã¦å®šç¾©ã—ã€ä¸¡é–¢æ•°ã§å†åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚

```python
def _dataframe_to_array(X):
    """MLã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ãŸã‚ã«DataFrameã‚’numpyé…åˆ—ã«å¤‰æ›ã€‚"""
    if isinstance(X, pd.DataFrame):
        if X.isnull().values.any():
            X = X.fillna(0.0)
        if X.empty:
            return np.array([]).reshape(0, 0)
        return X.values
    return X
```

### 2. `FractionalDifferentiation._get_weights` ã®ãƒ¡ãƒ¢åŒ–

**å•é¡Œ**:
`fractional_differentiation.py` ã® `_get_weights` ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€åŒã˜ `d` ã¨ `size` ã®çµ„ã¿åˆã‚ã›ã§ç¹°ã‚Šè¿”ã—å‘¼ã³å‡ºã•ã‚Œã‚‹å ´åˆã«å†è¨ˆç®—ã‚’è¡Œã„ã¾ã™ã€‚

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:
`@functools.lru_cache` ã‚’ä½¿ç”¨ã—ã¦çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã“ã¨ã§ã€ç¹°ã‚Šè¿”ã—å‘¼ã³å‡ºã—ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚ãŸã ã—ã€`size` ãŒéå¸¸ã«å¤§ãããªã‚‹å ´åˆã¯ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

## ğŸ› ï¸ ãã®ä»–ã®æ”¹å–„ææ¡ˆ (Other Suggestions - Round 4)

### 1. `PurgedKFold` ã®ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹å‡¦ç†

**å•é¡Œ**:
`purged_kfold.py` ã§ã¯ã€è¨ˆç®—ã•ã‚ŒãŸ `embargo_end_time` ãŒ `t1` ã®æœ€å¤§å€¤ã‚’è¶…ãˆã‚‹å ´åˆã‚„ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚»ãƒƒãƒˆãŒç©ºã«ãªã‚‹æ¥µç«¯ãªã‚±ãƒ¼ã‚¹ã§ã®æŒ™å‹•ãŒæ˜ç¢ºã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆ97-100 è¡Œï¼‰ã€‚

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:
ç©ºã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚»ãƒƒãƒˆãŒç”Ÿæˆã•ã‚Œã‚‹å ´åˆã«è­¦å‘Šã‚’å‡ºåŠ›ã™ã‚‹ã‹ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

```python
if len(train_indices) == 0:
    logger.warning(f"Fold {i+1}: Training set is empty after purging and embargo. Skipping this fold.")
    continue
```

### 2. `optimize_dtypes` ã®æ‹¡å¼µ

**å•é¡Œ**:
`ml_utils.py` ã® `optimize_dtypes` é–¢æ•°ã¯ `float64 -> float32` ã¨ `int64 -> int32` ã®å¤‰æ›ã®ã¿ã‚’è¡Œã£ã¦ã„ã¾ã™ãŒã€ä»–ã®ãƒ‡ãƒ¼ã‚¿å‹ï¼ˆä¾‹: `int32 -> int16`, `float32 -> float16`ï¼‰ã®æœ€é©åŒ–ã¯è€ƒæ…®ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:
ã‚ˆã‚Šç´°ã‹ã„ãƒ€ã‚¦ãƒ³ã‚­ãƒ£ã‚¹ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã‹ã€`pandas.to_numeric(downcast=...)` ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚ãŸã ã—ã€`float16` ã¯ç²¾åº¦ãŒä½ã„ãŸã‚ã€é‡‘èãƒ‡ãƒ¼ã‚¿ã§ã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

## âœ… Action Plan (Updated)

### High Priority

1. **[Fixed/Done] VolumeProfileFeatureCalculator ã« Numba ã‚’å°å…¥æ¸ˆã¿**
2. **[Done] TrendScanning ã« Numba ã‚’å°å…¥æ¸ˆã¿**

### Medium Priority

1. `MetricsCalculator` ã«è»½é‡ãƒ¢ãƒ¼ãƒ‰ ("lite") ã‚’å°å…¥ã€‚
2. **[Done]** `BaseMLTrainer.get_feature_importance` ã®ãƒ‡ãƒƒãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã€‚
3. **[Done]** `preprocessing/pipeline.py` ã®é‡è¤‡ `dataframe_to_array` é–¢æ•°ã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã€‚

### Low Priority

1. `presets.py` ã®ãƒ©ãƒ™ãƒ«å‹å®šç¾©ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–ã€‚
2. **[Done]** `MarketRegimeDetector._calculate_features` ã‚’ pandas rolling ã«ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã€‚
3. **[Done]** `PurgedKFold` ã«ç©ºãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚»ãƒƒãƒˆã®è­¦å‘Šã‚’è¿½åŠ ã€‚
4. `FractionalDifferentiation._get_weights` ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¿½åŠ ï¼ˆä»»æ„ï¼‰ã€‚
