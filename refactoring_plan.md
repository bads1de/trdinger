# リファクタリング計画：auto_strategy と indicators

## 目的

本ドキュメントは、`backend/app/core/services/auto_strategy` および `backend/app/core/services/indicators` ディレクトリ内のコードベースにおける重複、冗長性、および責務の不明確な箇所を特定し、それらに対するリファクタリング案を提示することを目的とします。これにより、コードの可読性、保守性、拡張性を向上させます。

## 概要

以下の主要なリファクタリング領域を特定しました。

---

## 1. API エンドポイントの改善 (`auto_strategy.py`)

### 現状の課題

`backend/app/api/auto_strategy.py` は、GA 戦略生成に関する API エンドポイントを提供していますが、いくつかの点で改善の余地があります。

- **依存性注入の単純さ**: `get_auto_strategy_service` による依存性注入は機能していますが、より複雑な依存関係に対応するには力不足です。
- **レスポンスモデルの重複**: 複数のレスポンスモデルで `success: bool` や `message: str` といった共通フィールドが重複して定義されています。
- **エラーハンドリングの分散**: エラーハンドリングが各エンドポイントで個別に行われており、一貫性がありません。

### 提案

API エンドポイントの保守性と拡張性を向上させるため、以下の改善を提案します。

1.  **DI コンテナの導入**:
    - `python-dependency-injector` のようなライブラリを導入し、`AutoStrategyService` やその他のサービスの依存関係をコンテナで管理します。これにより、依存関係の解決が自動化され、テストダブルの使用も容易になります。
2.  **レスポンスモデルの共通化**:
    - `success: bool` と `message: str` を持つベースレスポンスモデルを定義し、他のレスポンスモデルがそれを継承するようにします。これにより、コードの重複が削減され、API レスポンスの一貫性が向上します。
3.  **エラーハンドリングの一元化**:
    - FastAPI の例外ハンドラ (`@app.exception_handler`) を使用して、カスタム例外（例: `ExperimentNotFound`）を定義し、アプリケーション全体でエラーレスポンスを一元管理します。これにより、エンドポイント内のロジックが簡素化されます。

**期待される効果:**

- **保守性の向上**: 依存関係の管理とエラーハンドリングが一元化され、コードの保守が容易になります。
- **テストの容易化**: DI コンテナにより、サービスのモック化が簡単になり、ユニットテストの作成が効率化されます。
- **コードの DRY 原則**: レスポンスモデルの共通化により、コードの重複が排除されます。

---

## 4. サービスレイヤーと状態管理の改善 (`auto_strategy_service.py`)

### 現状の課題

- **複雑なシングルトン**: スレッドセーフなシングルトンパターンが実装されていますが、FastAPI の依存性注入の仕組みを使えばよりシンプルに実現できます。
- **永続的でない状態管理**: 実験の進捗や結果がメモリ上に保存されているため、サーバープロセスが再起動すると失われ、複数ワーカーでの実行に対応できません。
- **DB 接続管理**: データベース接続がインスタンス初期化時に一度だけ行われており、コネクションプールが有効に機能しない可能性があります。

### 提案

1.  **DI の活用**: シングルトン実装を廃止し、FastAPI の依存性注入（`Depends`）を使ってサービスのライフサイクルを管理します。
2.  **永続的な状態管理**: 実験の進捗や結果を、メモリではなく Redis やデータベースなどの永続ストアに保存するように変更します。
3.  **リクエスト毎の DB 接続**: リクエスト毎にデータベース接続を取得・解放するよう、FastAPI の標準的なパターンに変更します。

**期待される効果**: スケーラビリティと堅牢性の向上、コードの簡素化。

---

## 結論

本リファクタリング計画は、`auto_strategy` および `indicators` ディレクトリ内のコードの重複と複雑さを解消し、システムの全体的な健全性を向上させることを目指しています。提案された変更は、各モジュールの責務を明確にし、コードの一貫性を高め、将来的な機能拡張や保守を容易にするでしょう。

これらのリファクタリングは、一歩ずつ慎重に進める必要があります。特に、既存の機能への影響を最小限に抑えるため、単体テストと結合テストを徹底しながら実施することが重要です。TDD の原則に基づき、リファクタリングの各ステップでテストが確実にパスすることを確認します。

この計画が、より堅牢で保守しやすい取引戦略バックテストシステムの構築に貢献することを期待します。

---
