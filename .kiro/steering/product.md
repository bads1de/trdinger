---
inclusion: always
---

# Trdinger トレーディングプラットフォーム - 製品ガイドライン

ML を活用した戦略を持つアルゴリズム的仮想通貨トレーディングプラットフォーム。このコードベースで作業する際は、以下の規約に従ってください。

## 重要な財務ルール

- **必須：** すべての価格、金額、パーセンテージには `Decimal` 型を使用すること。決して `float` を使用しないこと。
- **必須：** 仮想通貨ペアの精度には小数点以下 8 桁を使用すること。
- **必須：** 市場データのタイムスタンプにはミリ秒精度を、ユーザー操作には秒精度を使用すること。
- **必須：** すべての財務計算は、既知の期待される結果を用いた単体テストで検証すること。
- **必須：** 財務計算には `ROUND_HALF_UP` を用いて適切な丸め処理を実装すること。

## コアドメインエンティティ

- **戦略 (Strategy)**: パラメータを持つトレーディングアルゴリズム。デプロイ前にバックテストが必須。
- **バックテスト (Backtest)**: 指標（シャープレシオ、最大ドローダウン、勝率）を用いた過去の検証。
- **ポートフォリオ (Portfolio)**: リアルタイムの P&L 追跡機能を持つポジションの集合。
- **シグナル (Signal)**: 信頼度スコア（0-1 の範囲）を持つ、ML によって生成された売買推奨。
- **ポジション (Position)**: エントリー/エグジットポイントとリスク管理ルールを持つアクティブなトレード。

## アーキテクチャパターン

### データフロー

この厳格なデータフローパターンに従うこと：

- 市場データ: `コレクター → データベース → 戦略エンジン → ポートフォリオ`
- ユーザー操作: `フロントエンド → API → ビジネスロジック → データベース`
- ML パイプライン: `生データ → 特徴量 → モデル → シグナル`

### コード構成

- **必須：** 依存性注入を用いて、トレーディングロジックをインフラストラクチャから分離すること。
- **必須：** トレーディングアルゴリズムにはストラテジーパターンを使用すること。
- **必須：** ML のトレーニングコードと推論コードは分離して管理すること。
- **必須：** すべてのデータアクセスにはリポジトリパターンを実装すること。
- **必須：** すべての I/O 操作には `async/await` を使用すること。

## セキュリティ要件

- **禁止：** API キーをレスポンス、ログ、エラーメッセージに記録したり、公開したりしないこと。
- **必須：** 機密性の高いトレーディングデータは保管時に暗号化すること。
- **必須：** すべてのポートフォリオの変更は、トランザクションレベルのロギングで監査すること。
- **必須：** 取引所ごと、環境ごとに別々の API キーを使用すること。
- **必須：** トレーディング操作を処理する前に、すべてのユーザー入力を検証すること。

## パフォーマンス基準

- 市場データ処理: **< 100ms**
- 戦略シグナル生成: **< 500ms**
- ポートフォリオ更新: **< 1 秒**
- **必須：** データベースおよび API 接続にはコネクションプーリングを実装すること。
- **必須：** 頻繁にアクセスされる市場データにはキャッシングを使用すること。

## エラーハンドリング

- **必須：** 回復可能なトレーディングエラーと致命的なトレーディングエラーを区別すること。
- **必須：** すべてのトレーディング決定を、監査証跡のために完全なコンテキストと共に記録すること。
- **必須：** API のレート制限に対してサーキットブレーカーを実装すること。
- **必須：** 外部サービスが失敗した場合には、グレースフルデグラデーションを提供すること。
- **必須：** トレーシングのために、相関 ID を持つ構造化ロギングを使用すること。

## UI/UX 規約

- **色分け**: 緑（利益/買い）、赤（損失/売り）、青（中立/ホールド）
- **必須：** すべてのトレーディング操作に対してローディング状態を表示すること。
- **必須：** 破壊的なアクション（戦略の停止、ポジションのクローズ）を確認すること。
- **必須：** ML の予測には信頼区間を表示すること。
- **必須：** ポートフォリオの価値とポジションのリアルタイム更新を表示すること。

## テスト要件

- **必須：** 単体テストでは、すべての外部取引所 API をモックすること。
- **必須：** 再現可能なバックテストのために、決定論的なシードを使用すること。
- **必須：** エッジケース（ゼロバランス、API 障害、極端な市場状況）をテストすること。
- **必須：** 既知の期待される結果で財務計算を検証すること。
- **必須：** 競合状態について、並行操作をテストすること。
- **必須：** 重要なトレーディングフローには統合テストを含めること。
