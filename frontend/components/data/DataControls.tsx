import React, { useState } from "react";
import SymbolSelector from "@/components/common/SymbolSelector";
import TimeFrameSelector from "@/components/common/TimeFrameSelector";
import DataCollectionButton from "@/components/button/DataCollectionButton";
import {
  allDataCollectionConfig,
  ohlcvCollectionConfig,
  fundingRateCollectionConfig,
  openInterestCollectionConfig,
  fearGreedCollectionConfig,
  externalMarketCollectionConfig,
} from "@/components/button/dataCollectionConfigs";
import DataResetPanel from "@/components/common/DataResetPanel";

import { TradingPair, TimeFrame } from "@/types/market-data";
import {
  AllDataCollectionResult,
  BulkOHLCVCollectionResult,
} from "@/types/data-collection";
import {
  BulkFundingRateCollectionResult,
  FundingRateCollectionResult,
} from "@/types/funding-rate";
import {
  BulkOpenInterestCollectionResult,
  OpenInterestCollectionResult,
} from "@/types/open-interest";
import { FearGreedCollectionResult } from "@/hooks/useFearGreedData";

interface DataControlsProps {
  symbols: TradingPair[];
  selectedSymbol: string;
  handleSymbolChange: (symbol: string) => void;
  symbolsLoading: boolean;
  loading: boolean;
  selectedTimeFrame: TimeFrame;
  handleTimeFrameChange: (timeFrame: TimeFrame) => void;
  updating: boolean;
  handleAllDataCollectionStart: (result: AllDataCollectionResult) => void;
  handleAllDataCollectionError: (errorMessage: string) => void;
  handleBulkCollectionStart: (result: BulkOHLCVCollectionResult) => void;
  handleBulkCollectionError: (errorMessage: string) => void;
  handleFundingRateCollectionStart: (
    result: BulkFundingRateCollectionResult | FundingRateCollectionResult
  ) => void;
  handleFundingRateCollectionError: (errorMessage: string) => void;
  handleOpenInterestCollectionStart: (
    result: BulkOpenInterestCollectionResult | OpenInterestCollectionResult
  ) => void;
  handleOpenInterestCollectionError: (errorMessage: string) => void;
  handleFearGreedCollectionStart: (result: FearGreedCollectionResult) => void;
  handleFearGreedCollectionError: (errorMessage: string) => void;
  bulkCollectionMessage: string;
  fundingRateCollectionMessage: string;
  openInterestCollectionMessage: string;
  fearGreedCollectionMessage: string;
  externalMarketCollectionMessage: string;
  allDataCollectionMessage: string;
  incrementalUpdateMessage: string;
  dataStatus: any; // TODO: „Çà„ÇäÂÖ∑‰ΩìÁöÑ„Å™Âûã„ÇíÊåáÂÆö„Åô„Çã
}

const DataControls: React.FC<DataControlsProps> = ({
  symbols,
  selectedSymbol,
  handleSymbolChange,
  symbolsLoading,
  loading,
  selectedTimeFrame,
  handleTimeFrameChange,
  updating,
  handleAllDataCollectionStart,
  handleAllDataCollectionError,
  handleBulkCollectionStart,
  handleBulkCollectionError,
  handleFundingRateCollectionStart,
  handleFundingRateCollectionError,
  handleOpenInterestCollectionStart,
  handleOpenInterestCollectionError,
  handleFearGreedCollectionStart,
  handleFearGreedCollectionError,
  bulkCollectionMessage,
  fundingRateCollectionMessage,
  openInterestCollectionMessage,
  fearGreedCollectionMessage,
  externalMarketCollectionMessage,
  allDataCollectionMessage,
  incrementalUpdateMessage,
  dataStatus,
}) => {
  const [showResetPanel, setShowResetPanel] = useState(false);
  return (
    <div className="enterprise-card animate-slide-up">
      <div className="p-6">
        {/* „Éá„Éº„Çø„Éô„Éº„ÇπÁä∂Ê≥Å„Çª„ÇØ„Ç∑„Éß„É≥ */}
        {dataStatus && dataStatus.data && (
          <div className="mb-6">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-semibold text-secondary-900 dark:text-secondary-100">
                üìä „Éá„Éº„Çø„Éô„Éº„ÇπÁä∂Ê≥Å
              </h2>
              <span className="badge-primary">
                {dataStatus.data.total_records?.toLocaleString()}‰ª∂
              </span>
            </div>

            {/* Á∑èË®àË°®Á§∫ */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm mb-4">
              <div className="flex justify-between">
                <span className="text-secondary-600 dark:text-secondary-400">
                  OHLCV:
                </span>
                <span className="font-medium text-secondary-900 dark:text-secondary-100">
                  {dataStatus.data.data_counts?.ohlcv?.toLocaleString()}‰ª∂
                </span>
              </div>
              <div className="flex justify-between">
                <span className="text-secondary-600 dark:text-secondary-400">
                  „Éï„Ç°„É≥„Éá„Ç£„É≥„Ç∞„É¨„Éº„Éà:
                </span>
                <span className="font-medium text-secondary-900 dark:text-secondary-100">
                  {dataStatus.data.data_counts?.funding_rates?.toLocaleString()}
                  ‰ª∂
                </span>
              </div>
              <div className="flex justify-between">
                <span className="text-secondary-600 dark:text-secondary-400">
                  „Ç™„Éº„Éó„É≥„Ç§„É≥„Çø„É¨„Çπ„Éà:
                </span>
                <span className="font-medium text-secondary-900 dark:text-secondary-100">
                  {dataStatus.data.data_counts?.open_interest?.toLocaleString()}
                  ‰ª∂
                </span>
              </div>
              <div className="flex justify-between">
                <span className="text-secondary-600 dark:text-secondary-400">
                  Fear & Greed Index:
                </span>
                <span className="font-medium text-secondary-900 dark:text-secondary-100">
                  {dataStatus.data.data_counts?.fear_greed_index?.toLocaleString() ||
                    0}
                  ‰ª∂
                </span>
              </div>
            </div>

            {/* OHLCVË©≥Á¥∞ÔºàÊôÇÈñìË∂≥Âà•Ôºâ */}
            {dataStatus.data.details?.ohlcv?.timeframes && (
              <div className="mb-4">
                <h3 className="text-lg font-medium text-secondary-800 dark:text-secondary-200 mb-2">
                  Ë©≥Á¥∞
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-5 gap-2 text-xs">
                  {Object.entries(dataStatus.data.details.ohlcv.timeframes).map(
                    ([tf, details]: [string, any]) => (
                      <div
                        key={tf}
                        className="bg-secondary-100 dark:bg-secondary-800 p-2 rounded"
                      >
                        <div className="font-medium text-secondary-900 dark:text-secondary-100">
                          {tf}
                        </div>
                        <div className="text-secondary-600 dark:text-secondary-400">
                          {details.count?.toLocaleString()}‰ª∂
                        </div>
                        {details.latest_timestamp && (
                          <div className="text-xs text-secondary-500 dark:text-secondary-500">
                            ÊúÄÊñ∞:{" "}
                            {new Date(
                              details.latest_timestamp
                            ).toLocaleDateString("ja-JP")}
                          </div>
                        )}
                      </div>
                    )
                  )}
                </div>
              </div>
            )}

            {/* FR„ÉªOI„ÉªFGË©≥Á¥∞ */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
              {/* „Éï„Ç°„É≥„Éá„Ç£„É≥„Ç∞„É¨„Éº„ÉàË©≥Á¥∞ */}
              {dataStatus.data.details?.funding_rates && (
                <div className="bg-secondary-100 dark:bg-secondary-800 p-3 rounded">
                  <h4 className="font-medium text-secondary-900 dark:text-secondary-100 mb-2">
                    „Éï„Ç°„É≥„Éá„Ç£„É≥„Ç∞„É¨„Éº„ÉàË©≥Á¥∞
                  </h4>
                  <div className="space-y-1">
                    <div className="flex justify-between">
                      <span className="text-secondary-600 dark:text-secondary-400">
                        ‰ª∂Êï∞:
                      </span>
                      <span>
                        {dataStatus.data.details.funding_rates.count?.toLocaleString()}
                        ‰ª∂
                      </span>
                    </div>
                    {dataStatus.data.details.funding_rates.latest_timestamp && (
                      <div className="flex justify-between">
                        <span className="text-secondary-600 dark:text-secondary-400">
                          ÊúÄÊñ∞:
                        </span>
                        <span>
                          {new Date(
                            dataStatus.data.details.funding_rates.latest_timestamp
                          ).toLocaleDateString("ja-JP")}
                        </span>
                      </div>
                    )}
                    {dataStatus.data.details.funding_rates.oldest_timestamp && (
                      <div className="flex justify-between">
                        <span className="text-secondary-600 dark:text-secondary-400">
                          ÊúÄÂè§:
                        </span>
                        <span>
                          {new Date(
                            dataStatus.data.details.funding_rates.oldest_timestamp
                          ).toLocaleDateString("ja-JP")}
                        </span>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* „Ç™„Éº„Éó„É≥„Ç§„É≥„Çø„É¨„Çπ„ÉàË©≥Á¥∞ */}
              {dataStatus.data.details?.open_interest && (
                <div className="bg-secondary-100 dark:bg-secondary-800 p-3 rounded">
                  <h4 className="font-medium text-secondary-900 dark:text-secondary-100 mb-2">
                    „Ç™„Éº„Éó„É≥„Ç§„É≥„Çø„É¨„Çπ„ÉàË©≥Á¥∞
                  </h4>
                  <div className="space-y-1">
                    <div className="flex justify-between">
                      <span className="text-secondary-600 dark:text-secondary-400">
                        ‰ª∂Êï∞:
                      </span>
                      <span>
                        {dataStatus.data.details.open_interest.count?.toLocaleString()}
                        ‰ª∂
                      </span>
                    </div>
                    {dataStatus.data.details.open_interest.latest_timestamp && (
                      <div className="flex justify-between">
                        <span className="text-secondary-600 dark:text-secondary-400">
                          ÊúÄÊñ∞:
                        </span>
                        <span>
                          {new Date(
                            dataStatus.data.details.open_interest.latest_timestamp
                          ).toLocaleDateString("ja-JP")}
                        </span>
                      </div>
                    )}
                    {dataStatus.data.details.open_interest.oldest_timestamp && (
                      <div className="flex justify-between">
                        <span className="text-secondary-600 dark:text-secondary-400">
                          ÊúÄÂè§:
                        </span>
                        <span>
                          {new Date(
                            dataStatus.data.details.open_interest.oldest_timestamp
                          ).toLocaleDateString("ja-JP")}
                        </span>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Fear & Greed IndexË©≥Á¥∞ */}
              {dataStatus.data.details?.fear_greed_index && (
                <div className="bg-secondary-100 dark:bg-secondary-800 p-3 rounded">
                  <h4 className="font-medium text-secondary-900 dark:text-secondary-100 mb-2">
                    Fear & Greed IndexË©≥Á¥∞
                  </h4>
                  <div className="space-y-1">
                    <div className="flex justify-between">
                      <span className="text-secondary-600 dark:text-secondary-400">
                        ‰ª∂Êï∞:
                      </span>
                      <span>
                        {dataStatus.data.details.fear_greed_index.count?.toLocaleString()}
                        ‰ª∂
                      </span>
                    </div>
                    {dataStatus.data.details.fear_greed_index
                      .latest_timestamp && (
                      <div className="flex justify-between">
                        <span className="text-secondary-600 dark:text-secondary-400">
                          ÊúÄÊñ∞:
                        </span>
                        <span>
                          {new Date(
                            dataStatus.data.details.fear_greed_index.latest_timestamp
                          ).toLocaleDateString("ja-JP")}
                        </span>
                      </div>
                    )}
                    {dataStatus.data.details.fear_greed_index
                      .oldest_timestamp && (
                      <div className="flex justify-between">
                        <span className="text-secondary-600 dark:text-secondary-400">
                          ÊúÄÂè§:
                        </span>
                        <span>
                          {new Date(
                            dataStatus.data.details.fear_greed_index.oldest_timestamp
                          ).toLocaleDateString("ja-JP")}
                        </span>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {/* „Éá„Éº„ÇøË®≠ÂÆö„Çª„ÇØ„Ç∑„Éß„É≥ */}
        <div className="flex items-center justify-between mb-6">
          <h2 className="text-lg font-semibold text-secondary-900 dark:text-secondary-100">
            üìà „Éá„Éº„ÇøË®≠ÂÆö
          </h2>
        </div>

        {/* Ë®≠ÂÆö„Ç≥„É≥„Éà„É≠„Éº„É´ */}
        <div className="space-y-6">
          {/* ‰∏äÊÆµÔºöÂü∫Êú¨Ë®≠ÂÆö */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {/* ÈÄöË≤®„Éö„Ç¢ÈÅ∏Êäû */}
            <SymbolSelector
              symbols={symbols}
              selectedSymbol={selectedSymbol}
              onSymbolChange={handleSymbolChange}
              loading={symbolsLoading}
              disabled={loading}
              mode="compact"
              showCategories={false}
              enableSearch={false}
            />

            {/* ÊôÇÈñìËª∏ÈÅ∏Êäû */}
            <TimeFrameSelector
              selectedTimeFrame={selectedTimeFrame}
              onTimeFrameChange={handleTimeFrameChange}
              disabled={loading}
              mode="compact"
            />
          </div>

          {/* ‰∏ãÊÆµÔºö„Éá„Éº„ÇøÂèéÈõÜ„Éú„Çø„É≥ */}
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <label className="block text-sm font-medium text-secondary-600 dark:text-secondary-400">
                „Éá„Éº„ÇøÂèéÈõÜ
              </label>
              <button
                onClick={() => setShowResetPanel(!showResetPanel)}
                className="text-sm text-warning-600 hover:text-warning-800 dark:text-warning-400 dark:hover:text-warning-200 font-medium"
              >
                {showResetPanel
                  ? "üîº „É™„Çª„ÉÉ„ÉàÊ©üËÉΩ„ÇíÈñâ„Åò„Çã"
                  : "üóëÔ∏è „Éá„Éº„Çø„É™„Çª„ÉÉ„Éà"}
              </button>
            </div>
            <div className="space-y-3">
              {/* ‰∏äÊÆµÔºö‰∏ªË¶Å„Éá„Éº„ÇøÂèéÈõÜ„Éú„Çø„É≥ */}
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
                {/* ÂÖ®„Éá„Éº„Çø‰∏ÄÊã¨ÂèéÈõÜ„Éú„Çø„É≥ */}
                <DataCollectionButton
                  config={allDataCollectionConfig}
                  onCollectionStart={handleAllDataCollectionStart}
                  onCollectionError={handleAllDataCollectionError}
                  disabled={loading || updating}
                  className="h-10 text-sm"
                />

                {/* OHLCVÂèéÈõÜ„Éú„Çø„É≥ */}
                <DataCollectionButton
                  config={ohlcvCollectionConfig}
                  onCollectionStart={handleBulkCollectionStart}
                  onCollectionError={handleBulkCollectionError}
                  disabled={loading || updating}
                  className="h-10"
                />

                {/* FRÂèéÈõÜ„Éú„Çø„É≥ */}
                <DataCollectionButton
                  config={fundingRateCollectionConfig}
                  onCollectionStart={handleFundingRateCollectionStart}
                  onCollectionError={handleFundingRateCollectionError}
                  disabled={loading || updating}
                  className="h-10"
                />

                {/* OIÂèéÈõÜ„Éú„Çø„É≥ */}
                <DataCollectionButton
                  config={openInterestCollectionConfig}
                  onCollectionStart={handleOpenInterestCollectionStart}
                  onCollectionError={handleOpenInterestCollectionError}
                  disabled={loading || updating}
                  className="h-10 bg-green-600 hover:bg-green-700 focus:ring-green-500"
                />

                {/* FGÂèéÈõÜ„Éú„Çø„É≥ */}
                <DataCollectionButton
                  config={fearGreedCollectionConfig}
                  onCollectionStart={handleFearGreedCollectionStart}
                  onCollectionError={handleFearGreedCollectionError}
                  disabled={loading || updating}
                  className="h-10"
                />
              </div>
            </div>
          </div>
        </div>

        {/* „Çπ„ÉÜ„Éº„Çø„Çπ„É°„ÉÉ„Çª„Éº„Ç∏ */}
        {(bulkCollectionMessage ||
          fundingRateCollectionMessage ||
          openInterestCollectionMessage ||
          fearGreedCollectionMessage ||
          externalMarketCollectionMessage ||
          allDataCollectionMessage ||
          incrementalUpdateMessage) && (
          <div className="mt-6 pt-4 border-t border-secondary-200 dark:border-secondary-700">
            <div className="space-y-2">
              {allDataCollectionMessage && (
                <div className="text-sm text-secondary-600 dark:text-secondary-400 font-medium">
                  {allDataCollectionMessage}
                </div>
              )}
              {incrementalUpdateMessage && (
                <div className="text-sm text-secondary-600 dark:text-secondary-400 font-medium">
                  {incrementalUpdateMessage}
                </div>
              )}
              {bulkCollectionMessage && (
                <div className="text-sm text-secondary-600 dark:text-secondary-400">
                  {bulkCollectionMessage}
                </div>
              )}
              {fundingRateCollectionMessage && (
                <div className="text-sm text-secondary-600 dark:text-secondary-400">
                  {fundingRateCollectionMessage}
                </div>
              )}
              {openInterestCollectionMessage && (
                <div className="text-sm text-secondary-600 dark:text-secondary-400">
                  {openInterestCollectionMessage}
                </div>
              )}
              {fearGreedCollectionMessage && (
                <div className="text-sm text-secondary-600 dark:text-secondary-400">
                  {fearGreedCollectionMessage}
                </div>
              )}
              {externalMarketCollectionMessage && (
                <div className="text-sm text-secondary-600 dark:text-secondary-400">
                  {externalMarketCollectionMessage}
                </div>
              )}
            </div>
          </div>
        )}
      </div>

      {/* „Éá„Éº„Çø„É™„Çª„ÉÉ„Éà„Éë„Éç„É´ */}
      {showResetPanel && (
        <div className="mt-4">
          <DataResetPanel
            selectedSymbol={selectedSymbol}
            isVisible={showResetPanel}
            onClose={() => setShowResetPanel(false)}
          />
        </div>
      )}
    </div>
  );
};

export default DataControls;
