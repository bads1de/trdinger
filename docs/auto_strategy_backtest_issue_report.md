# オートストラテジーのバックテスト問題に関する調査報告書

## 1. 問題の概要

オートストラテジー機能で生成された戦略のバックテストを実行した際、以下の問題が確認されました。

- **取引履歴の欠如**: バックテスト結果において、総取引数が常に 0 件となり、一切取引が行われません。
- **矛盾したパフォーマンス指標**: 取引がないにもかかわらず、総リターンや最大ドローダウンなどのパフォーマンス指標には数値が表示され、UI 上で矛盾した状態となっています。（例: 総リターン 99.43%, 総取引数 0）
- **結果の再現性**: この現象は、どの遺伝的アルゴリズムの実行においても同様に再現されます。

## 2. 原因分析

調査の結果、問題は主に以下の原因に起因していることが判明しました。

### 2.1. 矛盾したパフォーマンス指標の生成

UI 上で矛盾した結果が表示される原因は、`backtest_service.py` の結果変換ロジックにあります。

#### 2.1.1. 取引数 0 の場合の不適切な結果処理

- **箇所**: `BacktestService._convert_backtest_results` メソッド
- **問題**: `backtesting.py` ライブラリは、取引が 0 件の場合、結果オブジェクトに取引数や勝率のキーを含めません。現在の実装では `stats.get(key) or 0.0` という形式で値を取得しているため、取引数や勝率は `0` になる一方、リターンやドローダウンは `backtesting.py` が算出した「Buy & Hold」に近い値がそのまま入ってしまいます。
- **影響**: これにより、「リターンは計算されているが取引数は 0」という、ユーザーを混乱させる矛盾したデータが生成され、API からフロントエンドに返却されていました。

## 3. 修正方針の提案

上記の問題を解決するため、以下の修正を提案します。

### 3.1. パフォーマンス指標に関する修正

- **`backtest_service.py` の結果変換ロジックを修正**:
  - `_convert_backtest_results` メソッドの冒頭で、まず取引数 (`# Trades`) を確認します。
  - 取引数が 0 または存在しない場合は、リターン、シャープレシオ、ドローダウンなど、取引に依存するすべてのパフォーマンス指標を `0.0` に強制的に設定する処理を追加します。これにより、結果の矛盾を防ぎます。

---

**以上**
