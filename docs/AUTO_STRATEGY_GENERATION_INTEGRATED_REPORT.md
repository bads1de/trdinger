# 自動戦略生成機能 統合レポート

**バージョン**: 1.0  
**作成日**: 2024 年 12 月 19 日 (コードベース最終分析日)  
**ステータス**: ✅ 実用レベル達成 (総合完成度: 95%)

## 1. プロジェクト概要

### 1.1. 目的と背景

本プロジェクトの目的は、遺伝的アルゴリズム（GA）を活用し、複数のテクニカル指標を組み合わせた取引戦略を自動で生成・最適化する機能を開発することです。これにより、従来の手動による戦略設計の限界を克服し、データ駆動型のアプローチで市場環境に動的に適応可能な、高性能な取引戦略を発見することを目指します。

### 1.2. 達成状況

自動戦略生成機能のコア部分はすべて完成し、実用レベルに到達しています。バックエンドのロジック、API、フロントエンドの UI が密に連携し、ユーザーが戦略生成を簡単に行える環境が整いました。網羅的なテストスイートにより、システムの堅牢性と性能も確認済みです。残る主要なタスクは、生成された戦略と実験結果のデータベースへの永続化処理の実装のみです。

## 2. 最終アーキテクチャ

システムは、フロントエンド、API 層、ビジネスロジック層、データ層から構成されています。ユーザーからのリクエストは API を介して非同期で処理され、GA エンジンがバックテストを並列実行しながら最適な戦略を探索します。

```mermaid
graph TD
    subgraph "ユーザーインターフェース"
        A[フロントエンド<br>(OptimizationModal)]
    end

    subgraph "バックエンドAPI"
        B(FastAPI<br>/api/auto-strategy/*)
    end

    subgraph "ビジネスロジック (AutoStrategyService)"
        C{AutoStrategyService<br>(司令塔・非同期処理)}
        D[GAエンジン<br>(DEAP・並列計算)]
        E[戦略ファクトリー<br>(動的クラス生成)]
        F[バックテストサービス<br>(backtesting.py)]
    end

    subgraph "データ層"
        G[TALibアダプター<br>(指標計算)]
        H[データベース<br>(SQLite, SQLAlchemyモデル)]
    end

    A -- APIリクエスト --> B
    B -- 処理要求 --> C
    C -- GA実行指示 --> D
    D -- 個体評価要求 --> E
    E -- 動的戦略生成 --> F
    F -- 指標計算要求 --> G
    F -- バックテスト結果 --> D
    D -- フィットネス値 --> C
    C -- 進捗・結果 --> B
    B -- APIレスポンス --> A
    C -- 実験データ保存(TODO) --> H
```

## 3. 主要コンポーネント実装詳細

### 3.1. 戦略遺伝子 (`StrategyGene`)

- **ファイル**: `backend/app/core/services/auto_strategy/models/strategy_gene.py`
- **責務**: 取引戦略の設計図となる遺伝子構造を定義します。
- **v1 仕様**:
  - **最大指標数**: 5 つ
  - **売買条件**: 単純な比較条件（例: `RSI < 30`）のみ。
  - **エンコード**: 複雑な遺伝子情報を、`DEAP`が扱いやすい固定長の数値リストに変換するエンコード/デコードロジックを実装。ストレステストでも性能が確認されています。

### 3.2. GA エンジン (`GeneticAlgorithmEngine`)

- **ファイル**: `backend/app/core/services/auto_strategy/engines/ga_engine.py`
- **責務**: `DEAP`ライブラリを基盤とし、進化のプロセス（選択、交叉、突然変異）を管理します。
- **実装詳細**:
  - **並列評価**: `multiprocessing`を活用し、複数の戦略候補（個体）のバックテストを並列で実行することで、評価プロセスを大幅に高速化。
  - **フィットネス計算**: バックテスト結果（リターン、シャープレシオ、ドローダウン等）にユーザー定義の重みを適用し、戦略の総合的な「良さ」を算出します。

### 3.3. 戦略ファクトリー (`StrategyFactory`)

- **ファイル**: `backend/app/core/services/auto_strategy/factories/strategy_factory.py`
- **責務**: `StrategyGene`から、`backtesting.py`が実行可能な`Strategy`クラスを動的に生成します。
- **実装詳細**:
  - **指標対応**: 21 種類のテクニカル指標に対応。
  - **互換性**: `backtesting.py`が使用する内部データ形式 (`_Array`) と`pandas.Series`の非互換性を吸収する`_convert_to_series`メソッドを実装し、安定した指標計算を実現。

### 3.4. 統合サービス (`AutoStrategyService`)

- **ファイル**: `backend/app/core/services/auto_strategy/services/auto_strategy_service.py`
- **責務**: 機能全体の司令塔。GA の実行、進捗管理、結果取得などのワークフローを統合的に管理します。
- **実装詳細**:
  - **非同期実行**: `threading`を利用して GA の計算プロセスをバックグラウンドで実行。これにより、重い処理の最中でも API サーバーは他のリクエストに応答可能です。

### 3.5. フロントエンド

- **主要ファイル**: `GAConfigForm.tsx`, `useGAProgress.tsx`
- **責務**: ユーザーが GA の設定を行い、進捗をリアルタイムで確認するための UI を提供します。
- **実装詳細**:
  - **リッチな設定画面**: GA の各種パラメータ（個体数、世代数、フィットネスの重み等）を細かく調整できるフォームを実装。
  - **リアルタイム進捗表示**: カスタムフック`useGAProgress`が、進捗 API を定期的にポーリングし、現在の世代、最高フィットネス、推定残り時間などを動的に表示します。

## 4. API 仕様

フロントエンドとバックエンドは、以下の主要 API エンドポイントを通じて連携します。

| エンドポイント                                 | メソッド | 説明                                            |
| ---------------------------------------------- | -------- | ----------------------------------------------- |
| `/api/auto-strategy/generate`                  | `POST`   | GA による戦略生成タスクを開始します。           |
| `/api/auto-strategy/experiments/{id}/progress` | `GET`    | 特定の実験の進捗状況を返します。                |
| `/api/auto-strategy/experiments/{id}/results`  | `GET`    | 完了した実験の結果一覧を返します。              |
| `/api/auto-strategy/experiments/{id}/stop`     | `POST`   | 実行中の実験を停止します。                      |
| `/api/auto-strategy/test-strategy`             | `POST`   | 単一の戦略遺伝子をテスト実行します。            |
| `/api/auto-strategy/config/presets`            | `GET`    | GA 設定のプリセット（高速、標準等）を返します。 |

## 5. テストと品質評価

### 5.1. テストサマリー

本機能は、単体テスト、統合テスト、API テスト、ストレステストを含む網羅的なテストスイートによって品質が担保されています。

- **`test_comprehensive.py`**: 1000 個のランダムな遺伝子生成やシリアライズ性能など、システムの限界性能を試すストレステストを実施し、クリア済みです。
- **`test_api_integration.py`**: API の正常系ワークフローに加え、エラーハンドリング、同時リクエスト、レスポンス性能まで検証済みです。

### 5.2. 残存課題

- **DB 永続化**: `AutoStrategyService`における実験結果のデータベース保存処理が未実装です。ただし、`backend/database/models.py`に`GAExperiment`と`GeneratedStrategy`モデルが定義済みであり、このモデルを利用して結果を保存するロジックを追加するのみで対応可能です。

## 6. 今後の展望

### 6.1. 短期的な改善

1.  **DB 永続化処理の実装**: 最優先タスク。`AutoStrategyService`に結果を保存するロジックを追加します。
2.  **パフォーマンスチューニング**: より大規模な実験（例: 500 個体 ×200 世代）でのメモリ使用量や実行時間を計測し、ボトルネックを特定・改善します。
3.  **UI/UX 改善**: 結果の可視化（チャート表示など）を強化し、ユーザーが生成された戦略を分析しやすくします。

### 6.2. 中長期的な拡張

1.  **v2 仕様への拡張**: 遺伝子モデルを拡張し、複数の条件を組み合わせた複雑な売買ロジック（AND/OR）や、動的な指標数を扱えるようにします。
2.  **多目的最適化**: `NSGA-II`などのアルゴリズムを導入し、「リターンは高いがドローダウンは低い」といった、トレードオフの関係にある複数の目標を同時に最適化できるようにします。
3.  **機械学習手法の統合**: 強化学習などを組み合わせ、より高度な市場適応能力を持つ戦略の探索を目指します。

## 7. 結論

自動戦略生成機能は、設計、実装、テストの各段階を経て、非常に高い完成度に達しています。残る DB 永続化処理を実装することで、本機能は完全に実用可能な状態となります。この堅牢かつ高性能な基盤は、今後のさらなる機能拡張（多目的最適化、機械学習統合など）に向けた強力な土台となるものです。
